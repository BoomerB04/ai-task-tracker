<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title id="app-title">AI Task Tracker</title>
                
                <!-- PWA Meta Tags -->
                <link rel="manifest" href="manifest.json">
                    <meta name="theme-color" content="#3b82f6">
                        <meta name="mobile-web-app-capable" content="yes">
                            <meta name="apple-mobile-web-app-capable" content="yes">
                                <meta name="apple-mobile-web-app-status-bar-style" content="default">
                                    <meta name="apple-mobile-web-app-title" content="AI Task Tracker">
                                        <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'><path d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/></svg>">
                                            
                                            <style>
                                                * {
                                                    margin: 0;
                                                    padding: 0;
                                                    box-sizing: border-box;
                                                }
                                                
                                                /* Light mode (default) */
                                                :root {
                                                    --bg-primary: #f8fafc;
                                                    --bg-secondary: #ffffff;
                                                    --bg-tertiary: #f1f5f9;
                                                    --text-primary: #1e293b;
                                                    --text-secondary: #6b7280;
                                                    --text-tertiary: #9ca3af;
                                                    --border-color: #e2e8f0;
                                                    --border-light: #f1f5f9;
                                                    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
                                                    --shadow-md: 0 2px 8px rgba(0,0,0,0.1);
                                                    --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
                                                    --blue: #3b82f6;
                                                    --blue-dark: #2563eb;
                                                    --green: #059669;
                                                    --purple: #7c3aed;
                                                    --gray: #6b7280;
                                                    --red: #dc2626;
                                                }
                                                
                                                /* Dark mode */
                                                @media (prefers-color-scheme: dark) {
                                                    :root {
                                                        --bg-primary: #0f172a;
                                                        --bg-secondary: #1e293b;
                                                        --bg-tertiary: #334155;
                                                        --text-primary: #f8fafc;
                                                        --text-secondary: #cbd5e1;
                                                        --text-tertiary: #94a3b8;
                                                        --border-color: #334155;
                                                        --border-light: #475569;
                                                        --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
                                                        --shadow-md: 0 2px 8px rgba(0,0,0,0.4);
                                                        --shadow-lg: 0 4px 12px rgba(0,0,0,0.5);
                                                        --blue: #60a5fa;
                                                        --blue-dark: #3b82f6;
                                                        --green: #10b981;
                                                        --purple: #a855f7;
                                                        --gray: #94a3b8;
                                                        --red: #ef4444;
                                                    }
                                                }
                                                
                                                body {
                                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                                    background: var(--bg-primary);
                                                    color: var(--text-primary);
                                                    line-height: 1.6;
                                                    transition: background-color 0.3s ease, color 0.3s ease;
                                                }
                                                
                                                .container {
                                                    max-width: 1200px;
                                                    margin: 0 auto;
                                                    padding: 20px;
                                                }
                                                
                                                .app-header {
                                                    display: flex;
                                                    justify-content: space-between;
                                                    align-items: center;
                                                    margin-bottom: 20px;
                                                    flex-wrap: wrap;
                                                    gap: 15px;
                                                }
                                                
                                                .app-header h1 {
                                                    font-size: 28px;
                                                    font-weight: 700;
                                                    color: var(--text-primary);
                                                }
                                                
                                                .app-controls {
                                                    display: flex;
                                                    gap: 10px;
                                                }
                                                
                                                .workspace-tabs {
                                                    display: flex;
                                                    background: var(--bg-secondary);
                                                    border-radius: 12px;
                                                    padding: 6px;
                                                    box-shadow: var(--shadow-md);
                                                    margin-bottom: 20px;
                                                    overflow-x: auto;
                                                    gap: 4px;
                                                    border: 1px solid var(--border-color);
                                                }
                                                
                                                .tab.dragging {
                                                    opacity: 0.5;
                                                    transform: rotate(2deg);
                                                }

                                                .workspace-tabs .tab {
                                                    cursor: grab;
                                                }

                                                .workspace-tabs .tab:active {
                                                    cursor: grabbing;
                                                }
                                                
                                                .tab {
                                                    padding: 12px 16px;
                                                    border-radius: 8px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                    white-space: nowrap;
                                                    transition: all 0.2s;
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 8px;
                                                    min-width: fit-content;
                                                    background: var(--bg-tertiary);
                                                    border: 2px solid transparent;
                                                    color: var(--text-primary);
                                                }
                                                
                                                .tab:hover {
                                                    background: var(--border-light);
                                                }
                                                
                                                .tab.active {
                                                    background: var(--blue);
                                                    color: white;
                                                    border-color: var(--blue-dark);
                                                }
                                                
                                                .add-tab {
                                                    padding: 12px;
                                                    border-radius: 8px;
                                                    cursor: pointer;
                                                    color: var(--text-secondary);
                                                    transition: all 0.2s;
                                                    flex-shrink: 0;
                                                    background: var(--bg-tertiary);
                                                    border: 2px dashed var(--border-color);
                                                }
                                                
                                                .add-tab:hover {
                                                    background: var(--border-light);
                                                    color: var(--blue);
                                                    border-color: var(--blue);
                                                }
                                                
                                                .workspace-header {
                                                    display: flex;
                                                    justify-content: space-between;
                                                    align-items: center;
                                                    margin-bottom: 20px;
                                                    flex-wrap: wrap;
                                                    gap: 15px;
                                                }
                                                
                                                .workspace-title {
                                                    font-size: 22px;
                                                    font-weight: 600;
                                                    color: var(--text-primary);
                                                }
                                                
                                                .header-buttons {
                                                    display: flex;
                                                    gap: 10px;
                                                    flex-wrap: wrap;
                                                }
                                                
                                                .btn {
                                                    padding: 10px 16px;
                                                    border: none;
                                                    border-radius: 8px;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 8px;
                                                    font-size: 14px;
                                                }
                                                
                                                .btn:hover {
                                                    transform: translateY(-1px);
                                                    box-shadow: var(--shadow-md);
                                                }
                                                
                                                .btn-primary { background: var(--blue); color: white; }
                                                .btn-secondary { background: var(--gray); color: white; }
                                                .btn-purple { background: var(--purple); color: white; }
                                                .btn-green { background: var(--green); color: white; }
                                                
                                                .quick-add {
                                                    background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
                                                    border-radius: 8px;
                                                    padding: 16px;
                                                    box-shadow: var(--shadow-lg);
                                                    margin-bottom: 24px;
                                                    border: 2px solid rgba(255, 255, 255, 0.1);
                                                    max-width: 500px;
                                                }
                                                
                                                .quick-add h3 {
                                                    margin-bottom: 10px;
                                                    color: white;
                                                    font-size: 14px;
                                                    font-weight: 600;
                                                    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                                                }
                                                
                                                .quick-input {
                                                    width: 100% !important;
                                                    padding: 8px 12px !important;
                                                    border: 1px solid #e2e8f0 !important;
                                                    border-radius: 6px !important;
                                                    font-size: 13px !important;
                                                    margin-bottom: 10px !important;
                                                    resize: vertical !important;
                                                    min-height: 50px !important;
                                                    max-height: 100px !important;
                                                    background: #ffffff !important;
                                                    color: #000000 !important;
                                                    font-family: inherit !important;
                                                }
                                                
                                                .quick-input:focus {
                                                    outline: none;
                                                    border-color: rgba(255, 255, 255, 0.8);
                                                    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
                                                    background: white;
                                                }
                                                
                                                .quick-input::placeholder {
                                                    color: #000000 !important;
                                                    opacity: 1 !important;
                                                }
                                                
                                                .quick-buttons {
                                                    display: flex;
                                                    gap: 8px;
                                                    align-items: center;
                                                }
                                                
                                                .quick-buttons .btn {
                                                    padding: 8px 14px;
                                                    font-size: 13px;
                                                    font-weight: 600;
                                                    border-radius: 6px;
                                                    min-height: auto;
                                                }
                                                
                                                .quick-buttons .btn-green {
                                                    background: rgba(255, 255, 255, 0.95);
                                                    color: var(--green);
                                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                                }
                                                
                                                .quick-buttons .btn-green:hover {
                                                    background: white;
                                                    transform: translateY(-1px);
                                                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                                                }
                                                
                                                .quick-buttons .btn-purple {
                                                    background: rgba(255, 255, 255, 0.95);
                                                    color: var(--purple);
                                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                                }
                                                
                                                .quick-buttons .btn-purple:hover {
                                                    background: white;
                                                    transform: translateY(-1px);
                                                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                                                }
                                                
                                                .parsing-status {
                                                    padding: 8px 12px;
                                                    border-radius: 6px;
                                                    font-size: 14px;
                                                    font-weight: 500;
                                                }
                                                
                                                .status-parsing { background: #fef3c7; color: #92400e; }
                                                .status-success { background: #d1fae5; color: #065f46; }
                                                .status-error { background: #fee2e2; color: #991b1b; }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .status-parsing { background: #451a03; color: #fbbf24; }
                                                    .status-success { background: #064e3b; color: #10b981; }
                                                    .status-error { background: #7f1d1d; color: #f87171; }
                                                }
                                                
                                                .task-section {
                                                    margin-bottom: 32px;
                                                }
                                                
                                                .section-header {
                                                    font-size: 20px;
                                                    font-weight: 600;
                                                    margin-bottom: 16px;
                                                    padding-bottom: 8px;
                                                    border-bottom: 3px solid;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: space-between;
                                                }
                                                
                                                .overdue { border-color: #ef4444; color: #dc2626; }
                                                .today { border-color: var(--blue); color: var(--blue-dark); }
                                                .this-week { border-color: var(--green); color: #047857; }
                                                .next-week { border-color: var(--purple); color: #6d28d9; }
                                                .future { border-color: var(--gray); color: #4b5563; }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .overdue { color: #f87171; }
                                                    .today { color: var(--blue); }
                                                    .this-week { color: var(--green); }
                                                    .next-week { color: var(--purple); }
                                                    .future { color: var(--gray); }
                                                }
                                                
                                                .task-list {
                                                    display: flex;
                                                    flex-direction: column;
                                                    gap: 12px;
                                                }
                                                
                                                .task-card {
                                                    background: var(--bg-secondary);
                                                    border-radius: 10px;
                                                    padding: 20px;
                                                    box-shadow: var(--shadow-sm);
                                                    border: 1px solid var(--border-color);
                                                    transition: all 0.2s;
                                                }
                                                
                                                .task-card:hover {
                                                    box-shadow: var(--shadow-lg);
                                                    transform: translateY(-1px);
                                                }
                                                
                                                .task-header {
                                                    display: flex;
                                                    justify-content: space-between;
                                                    align-items: flex-start;
                                                    margin-bottom: 12px;
                                                }
                                                
                                                .task-title {
                                                    font-size: 16px;
                                                    font-weight: 600;
                                                    color: var(--text-primary);
                                                    flex: 1;
                                                    margin-right: 16px;
                                                }
                                                
                                                .task-actions {
                                                    display: flex;
                                                    gap: 8px;
                                                }
                                                
                                                .action-btn {
                                                    width: 32px;
                                                    height: 32px;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                    transition: all 0.2s;
                                                    font-size: 16px;
                                                }
                                                
                                                .action-btn:hover {
                                                    transform: scale(1.1);
                                                }
                                                
                                                .complete-btn { background: #ecfdf5; color: #059669; }
                                                .edit-btn { background: #eff6ff; color: #2563eb; }
                                                .delete-btn { background: #fef2f2; color: #dc2626; }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .complete-btn { background: #064e3b; color: #10b981; }
                                                    .edit-btn { background: #1e3a8a; color: #60a5fa; }
                                                    .delete-btn { background: #7f1d1d; color: #f87171; }
                                                }
                                                
                                                .task-meta {
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 12px;
                                                    flex-wrap: wrap;
                                                }

                                                .task-header-compact {
                                                    display: flex;
                                                    justify-content: space-between;
                                                    align-items: flex-start;
                                                    gap: 16px;
                                                }

                                                .task-content {
                                                    flex: 1;
                                                    min-width: 0;
                                                }

                                                .task-meta-inline {
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 8px;
                                                    flex-wrap: wrap;
                                                    margin-top: 6px;
                                                }

                                                .task-meta-inline .meta-item {
                                                    padding: 2px 6px;
                                                    border-radius: 8px;
                                                    font-size: 11px;
                                                    font-weight: 600;
                                                    white-space: nowrap;
                                                }

                                                .task-title-line {
                                                    display: flex;
                                                    align-items: baseline;
                                                    flex-wrap: wrap;
                                                    gap: 0;
                                                }

                                                .task-name {
                                                    font-size: 16px;
                                                    font-weight: 600;
                                                    color: var(--text-primary);
                                                    margin-right: 8px;
                                                    flex-shrink: 0;
                                                }

                                                .task-meta-text {
                                                    font-size: 12px;
                                                    color: var(--text-secondary);
                                                    font-weight: 500;
                                                    flex-shrink: 1;
                                                    min-width: 0;
                                                }
                                                
                                                .task-notes-toggle {
                                                    margin-top: 8px;
                                                }

                                                .notes-toggle-btn {
                                                    background: none;
                                                    border: none;
                                                    color: var(--text-secondary);
                                                    font-size: 12px;
                                                    cursor: pointer;
                                                    padding: 4px 0;
                                                }

                                                .notes-toggle-btn:hover {
                                                    color: var(--text-primary);
                                                }

                                                .task-notes {
                                                    margin-top: 6px;
                                                    padding: 8px;
                                                    background: var(--bg-tertiary);
                                                    border-radius: 6px;
                                                    font-size: 13px;
                                                    color: var(--text-secondary);
                                                    border-left: 3px solid var(--blue);
                                                }

                                                .toggle-icon {
                                                    transition: transform 0.2s;
                                                }

                                                .toggle-icon.expanded {
                                                    transform: rotate(180deg);
                                                }
                                                
                                                .meta-item {
                                                    padding: 4px 8px;
                                                    border-radius: 12px;
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                }
                                                
                                                .priority-p0 { background: #fee2e2; color: #991b1b; }
                                                .priority-p1 { background: #fed7aa; color: #c2410c; }
                                                .priority-p2 { background: #fef3c7; color: #a16207; }
                                                .priority-p3 { background: #dcfce7; color: #166534; }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .priority-p0 { background: #7f1d1d; color: #f87171; }
                                                    .priority-p1 { background: #9a3412; color: #fb923c; }
                                                    .priority-p2 { background: #a16207; color: #fbbf24; }
                                                    .priority-p3 { background: #166534; color: #4ade80; }
                                                }
                                                
                                                /* Low-High Priority Styles */
                                                .priority-critical { background: #fee2e2; color: #991b1b; }
                                                .priority-high { background: #fed7aa; color: #c2410c; }
                                                .priority-medium { background: #fef3c7; color: #a16207; }
                                                .priority-low { background: #dcfce7; color: #166534; }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .priority-critical { background: #7f1d1d; color: #f87171; }
                                                    .priority-high { background: #9a3412; color: #fb923c; }
                                                    .priority-medium { background: #a16207; color: #fbbf24; }
                                                    .priority-low { background: #166534; color: #4ade80; }
                                                }
                                                
                                                /* Category Color Styles */
                                                .category-blue { background: #dbeafe; color: #1e40af; }
                                                .category-green { background: #dcfce7; color: #166534; }
                                                .category-purple { background: #e9d5ff; color: #7c2d12; }
                                                .category-orange { background: #fed7aa; color: #c2410c; }
                                                .category-red { background: #fee2e2; color: #991b1b; }
                                                .category-pink { background: #fce7f3; color: #be185d; }
                                                .category-teal { background: #ccfbf1; color: #0f766e; }
                                                .category-gray { background: #f3f4f6; color: #374151; }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .category-blue { background: #1e3a8a; color: #60a5fa; }
                                                    .category-green { background: #166534; color: #4ade80; }
                                                    .category-purple { background: #581c87; color: #c084fc; }
                                                    .category-orange { background: #9a3412; color: #fb923c; }
                                                    .category-red { background: #7f1d1d; color: #f87171; }
                                                    .category-pink { background: #831843; color: #f9a8d4; }
                                                    .category-teal { background: #0f766e; color: #5eead4; }
                                                    .category-gray { background: #374151; color: #d1d5db; }
                                                }
                                                
                                                .modal {
                                                    display: none;
                                                    position: fixed;
                                                    top: 0;
                                                    left: 0;
                                                    width: 100%;
                                                    height: 100%;
                                                    background: rgba(0,0,0,0.5);
                                                    z-index: 1000;
                                                }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .modal {
                                                        background: rgba(0,0,0,0.7);
                                                    }
                                                }
                                                
                                                .modal.show {
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                }
                                                
                                                .modal-content {
                                                    background: var(--bg-secondary);
                                                    padding: 24px;
                                                    border-radius: 12px;
                                                    width: 90%;
                                                    max-width: 500px;
                                                    max-height: 80vh;
                                                    overflow-y: auto;
                                                    border: 1px solid var(--border-color);
                                                }
                                                
                                                .form-group {
                                                    margin-bottom: 16px;
                                                }
                                                
                                                .form-label {
                                                    display: block;
                                                    margin-bottom: 6px;
                                                    font-weight: 600;
                                                    color: var(--text-primary);
                                                }
                                                
                                                .form-input, .form-select {
                                                    width: 100%;
                                                    padding: 10px 12px;
                                                    border: 2px solid var(--border-color);
                                                    border-radius: 6px;
                                                    font-size: 14px;
                                                    background: var(--bg-primary);
                                                    color: var(--text-primary);
                                                }
                                                
                                                .form-input:focus, .form-select:focus {
                                                    outline: none;
                                                    border-color: var(--blue);
                                                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                                                }
                                                
                                                .date-input-group {
                                                    position: relative;
                                                }
                                                
                                                .date-input-group input[type="date"] {
                                                    position: absolute;
                                                    right: 8px;
                                                    top: 50%;
                                                    transform: translateY(-50%);
                                                    width: 24px;
                                                    height: 24px;
                                                    opacity: 0;
                                                    cursor: pointer;
                                                }
                                                
                                                .calendar-icon {
                                                    position: absolute;
                                                    right: 12px;
                                                    top: 50%;
                                                    transform: translateY(-50%);
                                                    pointer-events: none;
                                                    color: var(--text-tertiary);
                                                }
                                                
                                                .empty-state {
                                                    text-align: center;
                                                    padding: 60px 20px;
                                                    color: var(--text-secondary);
                                                }
                                                
                                                .empty-state h3 {
                                                    font-size: 18px;
                                                    margin-bottom: 8px;
                                                    color: var(--text-primary);
                                                }
                                                
                                                .archive-task {
                                                    background: var(--bg-tertiary);
                                                    border-color: var(--border-light);
                                                }
                                                
                                                .archive-task .task-title {
                                                    text-decoration: line-through;
                                                    color: var(--text-secondary);
                                                }
                                                
                                                .workspace-item {
                                                    display: flex;
                                                    justify-content: space-between;
                                                    align-items: center;
                                                    padding: 12px;
                                                    background: var(--bg-tertiary);
                                                    border-radius: 8px;
                                                    margin-bottom: 8px;
                                                    border: 1px solid var(--border-color);
                                                }
                                                
                                                .workspace-info {
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 12px;
                                                    flex: 1;
                                                }
                                                
                                                .workspace-emoji {
                                                    font-size: 18px;
                                                }
                                                
                                                .workspace-name {
                                                    font-weight: 600;
                                                    color: var(--text-primary);
                                                }
                                                
                                                .workspace-stats {
                                                    font-size: 12px;
                                                    color: var(--text-secondary);
                                                }
                                                
                                                .workspace-actions {
                                                    display: flex;
                                                    gap: 8px;
                                                }
                                                
                                                .missing-field {
                                                    background-color: #fef3c7 !important;
                                                    border-radius: 6px !important;
                                                    padding: 4px !important;
                                                }
                                                
                                                .field-note {
                                                    font-size: 11px;
                                                    color: #92400e;
                                                    margin-top: 4px;
                                                }
                                                
                                                .field-error {
                                                    border-color: #ef4444 !important;
                                                    background-color: #fef2f2 !important;
                                                }
                                                
                                                .error-message {
                                                    font-size: 12px;
                                                    color: #dc2626;
                                                    margin-top: 4px;
                                                    display: none;
                                                }
                                                
                                                @media (prefers-color-scheme: dark) {
                                                    .field-error {
                                                        border-color: #f87171 !important;
                                                        background-color: #7f1d1d !important;
                                                    }
                                                    .error-message {
                                                        color: #f87171;
                                                    }
                                                }
                                                
                                                @media (max-width: 768px) {
                                                    .container {
                                                        padding: 12px;
                                                    }
                                                    
                                                    .app-header {
                                                        flex-direction: column;
                                                        align-items: stretch;
                                                        margin-bottom: 15px;
                                                    }
                                                    
                                                    .app-header h1 {
                                                        font-size: 24px;
                                                        text-align: center;
                                                    }
                                                    
                                                    .workspace-tabs {
                                                        padding: 4px;
                                                        margin-bottom: 15px;
                                                        overflow-x: auto;
                                                        scrollbar-width: none;
                                                        -ms-overflow-style: none;
                                                    }
                                                    
                                                    .workspace-tabs::-webkit-scrollbar {
                                                        display: none;
                                                    }
                                                    
                                                    .tab {
                                                        padding: 14px 18px;
                                                        font-size: 16px;
                                                        min-width: 120px;
                                                        touch-action: manipulation;
                                                    }
                                                    
                                                    .add-tab {
                                                        padding: 14px;
                                                        font-size: 18px;
                                                        min-width: 50px;
                                                    }
                                                    
                                                    .workspace-header {
                                                        flex-direction: column;
                                                        align-items: stretch;
                                                        margin-bottom: 15px;
                                                    }
                                                    
                                                    .workspace-title {
                                                        font-size: 20px;
                                                        text-align: center;
                                                        margin-bottom: 15px;
                                                    }
                                                    
                                                    .header-buttons {
                                                        justify-content: center;
                                                        gap: 8px;
                                                    }
                                                    
                                                    .btn {
                                                        padding: 12px 16px;
                                                        font-size: 16px;
                                                        min-height: 44px;
                                                        touch-action: manipulation;
                                                    }
                                                    
                                                    .quick-add {
                                                        padding: 20px;
                                                        margin-bottom: 20px;
                                                    }
                                                    
                                                    .quick-add h3 {
                                                        font-size: 18px;
                                                    }
                                                    
                                                    .quick-input {
                                                        font-size: 16px;
                                                        min-height: 100px;
                                                        padding: 14px 16px;
                                                    }
                                                    
                                                    .quick-buttons {
                                                        flex-direction: column;
                                                        align-items: stretch;
                                                        gap: 12px;
                                                    }
                                                    
                                                    .parsing-status {
                                                        text-align: center;
                                                    }
                                                    
                                                    .task-header {
                                                        flex-direction: column;
                                                        align-items: stretch;
                                                        gap: 12px;
                                                    }
                                                    
                                                    .task-title {
                                                        font-size: 18px;
                                                        margin-right: 0;
                                                        margin-bottom: 8px;
                                                    }
                                                    
                                                    .task-actions {
                                                        justify-content: center;
                                                        align-self: center;
                                                    }
                                                    
                                                    .action-btn {
                                                        width: 44px;
                                                        height: 44px;
                                                        font-size: 18px;
                                                    }
                                                    
                                                    .task-meta {
                                                        justify-content: center;
                                                        gap: 8px;
                                                    }
                                                    
                                                    .meta-item {
                                                        font-size: 11px;
                                                        padding: 6px 10px;
                                                    }
                                                    
                                                    .section-header {
                                                        font-size: 18px;
                                                        text-align: center;
                                                    }
                                                    
                                                    .modal-content {
                                                        width: 95%;
                                                        margin: 20px;
                                                        max-height: 90vh;
                                                        padding: 20px;
                                                    }
                                                    
                                                    .form-input, .form-select {
                                                        font-size: 16px;
                                                        padding: 14px 16px;
                                                        min-height: 50px;
                                                    }
                                                    
                                                    .form-label {
                                                        font-size: 16px;
                                                        margin-bottom: 8px;
                                                    }
                                                    
                                                    .workspace-item {
                                                        padding: 16px;
                                                        flex-direction: column;
                                                        align-items: stretch;
                                                        gap: 12px;
                                                    }
                                                    
                                                    .workspace-info {
                                                        justify-content: center;
                                                    }
                                                    
                                                    .workspace-emoji {
                                                        font-size: 24px;
                                                    }
                                                    
                                                    .workspace-name {
                                                        font-size: 18px;
                                                    }
                                                    
                                                    .workspace-actions {
                                                        justify-content: center;
                                                    }
                                                    
                                                    .empty-state {
                                                        padding: 40px 20px;
                                                    }
                                                    
                                                    .empty-state h3 {
                                                        font-size: 20px;
                                                    }
                                                    
                                                    .btn, .form-input, .form-select, .quick-input {
                                                        -webkit-appearance: none;
                                                        border-radius: 8px;
                                                    }
                                                    
                                                    .form-input:focus, .form-select:focus, .quick-input:focus {
                                                        font-size: 16px;
                                                    }
                                                    
                                                    .tab, .add-tab, .btn, .action-btn {
                                                        min-height: 44px;
                                                        min-width: 44px;
                                                    }
                                                    
                                                    .header-buttons {
                                                        display: grid;
                                                        grid-template-columns: 1fr 1fr;
                                                        gap: 8px;
                                                    }
                                                    
                                                    .header-buttons .btn:last-child {
                                                        grid-column: 1 / -1;
                                                    }
                                                    
                                                    .header-buttons .btn:last-child {
                                                            grid-column: 1 / -1;
                                                        }
                                                        
                                                        .task-title-line {
                                                            flex-direction: column;
                                                            align-items: flex-start;
                                                            gap: 4px;
                                                        }
                                                        
                                                        .task-name {
                                                            margin-right: 0;
                                                            margin-bottom: 2px;
                                                        }
                                                    }
                                                }
                                                
                                                @media (max-width: 428px) {
                                                    .container {
                                                        padding: 10px;
                                                    }
                                                    
                                                    .workspace-tabs {
                                                        margin-left: -10px;
                                                        margin-right: -10px;
                                                        padding-left: 14px;
                                                        padding-right: 14px;
                                                    }
                                                    
                                                    .quick-add, .task-card {
                                                        border-radius: 12px;
                                                    }
                                                    
                                                    .header-buttons {
                                                        grid-template-columns: 1fr;
                                                        gap: 10px;
                                                    }
                                                    
                                                    .task-card {
                                                        padding: 16px;
                                                    }
                                                    
                                                    .app-header h1 {
                                                        font-size: 22px;
                                                    }
                                                }
                                                
                                                @media (max-width: 768px) and (orientation: landscape) {
                                                    .workspace-header {
                                                        flex-direction: row;
                                                        align-items: center;
                                                    }
                                                    
                                                    .workspace-title {
                                                        text-align: left;
                                                        margin-bottom: 0;
                                                    }
                                                    
                                                    .header-buttons {
                                                        display: flex;
                                                        flex-direction: row;
                                                    }
                                                    
                                                    .quick-buttons {
                                                        flex-direction: row;
                                                        align-items: center;
                                                    }
                                                }
                                                
                                                .tab {
                                                    user-select: none;
                                                    -webkit-user-select: none;
                                                    -webkit-tap-highlight-color: transparent;
                                                }
                                                
                                                .btn, .action-btn {
                                                    -webkit-tap-highlight-color: transparent;
                                                    user-select: none;
                                                }
                                                
                                                .workspace-tabs {
                                                    scroll-behavior: smooth;
                                                }
                                                
                                                @media (display-mode: standalone) {
                                                    body {
                                                        padding-top: env(safe-area-inset-top);
                                                        padding-bottom: env(safe-area-inset-bottom);
                                                    }
                                                    
                                                    .container {
                                                        padding-top: 10px;
                                                    }
                                                    
                                                </style>
                                            <!-- Firebase Scripts -->
                                                <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
                                                <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
                                                <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    </head>
<body>
    <div class="container">
        <div class="app-header">
            <h1 id="app-name">🤖 AI Task Tracker</h1>
            <div class="app-controls">
                <button class="btn btn-secondary" onclick="exportData()" title="Export Data">
                    📤 Export
                </button>
                <button class="btn btn-secondary" onclick="importData()" title="Import Data">
                    📥 Import
                </button>
                <button class="btn btn-secondary" onclick="showSettingsModal()" title="App Settings">
                    ⚙️
                </button>
                <button class="btn btn-green" onclick="refreshFromFirebase()" title="Refresh Data from Server">
                    🔄 Refresh
                </button>
                <button class="btn btn-secondary" onclick="showHelpModal()" title="Help & Documentation">
                    ❓ Help
                </button>
                <button class="btn btn-secondary" onclick="logOut()" title="Log Out">
                    🚪 Logout
                </button>
            </div>
        </div>

        <!-- Workspace Tabs -->
        <div class="workspace-tabs" id="workspaceTabs">
            <!-- Tabs will be populated here -->
        </div>

        <!-- Current Workspace Content -->
        <div id="workspaceContent">
            <div class="workspace-header">
                <div class="workspace-title" id="workspaceTitle">💼 Work</div>
                <div class="header-buttons">
                    <button class="btn btn-purple" onclick="toggleCategoryManager()">📂 Categories</button>
                    <button class="btn btn-secondary" onclick="showFieldConfigModal()">⚙️ Fields</button>
                    <button class="btn btn-secondary" onclick="showDefaultsModal()">🎯 Defaults</button>
                    <button class="btn btn-secondary" onclick="toggleArchive()">🗄️ Archive (<span id="archive-count">0</span>)</button>
                    <button class="btn btn-primary" onclick="showAddModal()">➕ Add Task</button>
                </div>
            </div>

            <div class="quick-add">
                <h3>✨ Quick Add with AI</h3>
                <textarea
                    class="quick-input"
                    id="quickInput"
                    placeholder="Just type naturally! e.g., 'Review API docs by Friday, high priority, 2 hours, product work'"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); parseQuickInput();}"
                ></textarea>
                <div class="quick-buttons">
                    <button class="btn btn-green" onclick="parseQuickInput()">Add Task</button>
                    <button class="btn btn-purple" onclick="startVoiceInput()" id="voiceBtn" title="Voice input">🎤 Voice</button>
                    <div id="parseStatus" class="parsing-status" style="display: none;"></div>
                </div>
            </div>

            <div id="taskSections">
                <!-- Task sections will be populated here -->
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No tasks yet!</h3>
                <p>Use the AI input above or click "Add Task" to get started.</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <h3>App Settings</h3>
                <div class="form-group">
                    <label class="form-label">App Name</label>
                    <input type="text" id="appNameInput" class="form-input" placeholder="My Task Tracker">
                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                        Customize your app name (appears in browser tab and when installed as PWA)
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn btn-green" onclick="saveAppSettings()" style="flex: 1;">Save Settings</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>

    <!-- Field Defaults Modal -->
    <div id="defaultsModal" class="modal">
        <div class="modal-content">
            <h3>Set Default Values for <span id="defaultsWorkspaceName"></span></h3>
            <div style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                Set default values that will pre-fill when creating new tasks in this workspace.
            </div>
            
            <div id="defaultsList">
                <!-- Populated dynamically -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 24px;">
                <button class="btn btn-green" onclick="saveDefaults()" style="flex: 1;">Save Defaults</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Workspace Modal -->
    <div id="workspaceModal" class="modal">
        <div class="modal-content">
            <h3 id="workspaceModalTitle">Create New Workspace</h3>
            <div class="form-group">
                <label class="form-label">Workspace Name</label>
                <input type="text" id="workspaceName" class="form-input" placeholder="e.g., Personal, Project X, etc.">
            </div>
            <div class="form-group">
                <label class="form-label">Emoji/Icon</label>
                <input type="text" id="workspaceEmoji" class="form-input" placeholder="🏠 (optional)" maxlength="2">
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                    Suggestions: 💼 🏠 🚀 📊 🎯 📚 🛠️ 🎨 💡 🔬
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 24px;">
                <button class="btn btn-green" onclick="saveWorkspaceChanges()" style="flex: 1;" id="workspaceSubmitBtn">Create</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Workspace Manager Modal -->
    <div id="workspaceManagerModal" class="modal">
        <div class="modal-content">
            <h3>Manage Workspaces</h3>
            <div id="workspaceManagerList" style="margin-bottom: 20px;">
                <!-- Populated dynamically -->
            </div>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Add New Task</h3>
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" id="taskName" class="form-input" required>
                    <div id="taskNameError" class="error-message">Task name is required</div>
                </div>
                <div class="form-group" id="dueDateGroup">
                    <label class="form-label">Due Date</label>
                    <div class="date-input-group">
                        <input type="text" id="taskDate" class="form-input" placeholder="MM/DD or M/D/YY">
                        <input type="date" id="taskDatePicker">
                        <span class="calendar-icon">📅</span>
                    </div>
                    <div id="taskDateError" class="error-message">Due date is required</div>
                </div>
                <div class="form-group" id="priorityGroup">
                    <label class="form-label">Priority</label>
                    <select id="taskPriority" class="form-select">
                        <!-- Populated dynamically -->
                    </select>
                    <div id="taskPriorityError" class="error-message">Priority is required</div>
                </div>
                <div class="form-group" id="timeEstimateGroup">
                    <label class="form-label">Time Estimate (minutes)</label>
                    <input type="number" id="taskTime" class="form-input" min="1">
                    <div id="taskTimeError" class="error-message">Time estimate is required</div>
                </div>
                <div class="form-group" id="taskCategoryGroup">
                    <label class="form-label">Task Category</label>
                    <select id="taskCategory" class="form-select">
                        <!-- Populated dynamically -->
                    </select>
                    <div id="taskCategoryError" class="error-message">Category is required</div>
                </div>
                <div class="form-group" id="notesGroup">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea id="taskNotes" class="form-input" placeholder="Additional details, context, or notes..." rows="3" style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button type="submit" class="btn btn-green" style="flex: 1;">Save Task</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Type Manager Modal -->
        <div id="typeModal" class="modal">
            <div class="modal-content">
                <h3>Manage Task Categories</h3>
                <div id="typeList" style="margin-bottom: 20px;">
                    <!-- Populated dynamically -->
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="newTypeName" class="form-input" placeholder="New category name" style="flex: 1;">
                    <input type="text" id="newTypeEmoji" class="form-input" placeholder="📁" maxlength="2" style="width: 60px;">
                    <select id="newTypeColor" class="form-select" style="width: 120px;">
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                        <option value="red">Red</option>
                        <option value="pink">Pink</option>
                        <option value="teal">Teal</option>
                        <option value="gray">Gray</option>
                    </select>
                    <button class="btn btn-purple" onclick="addtaskCategory()">Add</button>
                </div>
                <button class="btn btn-secondary" onclick="closeCategoryManager()">Close</button>
            </div>
        </div>

    <!-- Field Configuration Modal -->
    <div id="fieldConfigModal" class="modal">
        <div class="modal-content">
            <h3>Configure Fields for <span id="fieldConfigWorkspaceName"></span></h3>
            <div style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                Choose which fields are relevant for this workspace. Disabled fields won't appear in forms or trigger missing field warnings.
            </div>
            
            <div id="fieldConfigList">
                <!-- Populated dynamically -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 24px;">
                <button class="btn btn-green" onclick="saveFieldConfig()" style="flex: 1;">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Help/Documentation Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 16px;">
                    <h2 style="margin: 0; color: var(--text-primary);">🤖 AI Task Tracker - Help & Documentation</h2>
                    <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
                </div>
                
                <div style="overflow-y: auto; max-height: calc(85vh - 120px);">
                    <div style="line-height: 1.6; color: var(--text-primary);">
                        
                        <div style="background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0;">Get Started in 2 Minutes</h3>
                            <p style="margin: 0; opacity: 0.9;">Smart, cross-device task management with AI-powered natural language input. Real-time syncing across all devices.</p>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="color: var(--blue); margin-bottom: 16px;">🚀 Quick Start</h3>
                            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <h4 style="margin: 0 0 8px 0;">Try typing this:</h4>
                                <code style="background: var(--bg-secondary); padding: 8px; border-radius: 4px; display: block; font-family: monospace;">Review presentation by Friday, high priority, 2 hours</code>
                            </div>
                            <p>The app automatically organizes this into: <strong>Task:</strong> Review presentation, <strong>Due:</strong> Friday, <strong>Priority:</strong> High, <strong>Time:</strong> 2 hours</p>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="color: var(--green); margin-bottom: 16px;">✨ Key Features</h3>
                            <ul style="padding-left: 20px;">
                                <li><strong>AI-Powered Input:</strong> Type naturally or use voice input for automatic parsing</li>
                                <li><strong>Smart Organization:</strong> Auto-categorizes by Overdue, Today, This Week, Next Week, Future</li>
                                <li><strong>Cross-Device Sync:</strong> Real-time updates across all your devices</li>
                                <li><strong>Custom Workspaces:</strong> Separate Work, Personal, Project spaces</li>
                                <li><strong>Flexible Priorities:</strong> Choose P0-P3 or Low-High priority systems</li>
                                <li><strong>Custom Categories:</strong> Create categories with colors and emojis</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="color: var(--purple); margin-bottom: 16px;">💡 Natural Language Examples</h3>
                            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                                <div style="margin-bottom: 8px;"><code>"Meeting with client next Tuesday, work category, 1 hour"</code></div>
                                <div style="margin-bottom: 8px;"><code>"Buy groceries tomorrow, personal, low priority"</code></div>
                                <div style="margin-bottom: 8px;"><code>"Finish project proposal by 12/15, critical"</code></div>
                                <div><code>"Call doctor tomorrow, 30 minutes"</code></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="color: var(--blue); margin-bottom: 16px;">📱 Install as App</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0;">Mobile</h4>
                                    <ol style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        <li>Open in your browser</li>
                                        <li>Look for "Add to Home Screen"</li>
                                        <li>Install as native app</li>
                                    </ol>
                                </div>
                                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0;">Desktop</h4>
                                    <ol style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        <li>Open in Chrome or Edge</li>
                                        <li>Click install button in address bar</li>
                                        <li>Adds to your applications</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="color: var(--red); margin-bottom: 16px;">🔒 Privacy & Security</h3>
                            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--green);">
                                <p style="margin: 0 0 12px 0;"><strong>Your data is secure and private:</strong></p>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li>Only accessible with your login credentials</li>
                                    <li>Complete user isolation - no one else can see your data</li>
                                    <li>No tracking or data sharing</li>
                                    <li>Works offline, syncs when connected</li>
                                </ul>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="color: var(--gray); margin-bottom: 16px;">🛠 Troubleshooting</h3>
                            <details style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <summary style="cursor: pointer; font-weight: 600;">Can't access tasks?</summary>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    • Verify login credentials are correct<br>
                                    • Check internet connection<br>
                                    • Try refreshing the page<br>
                                    • Click the 🔄 Refresh button
                                </div>
                            </details>
                            <details style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <summary style="cursor: pointer; font-weight: 600;">App won't load?</summary>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    • Clear browser cache and cookies<br>
                                    • Try incognito/private browsing mode<br>
                                    • Use a modern browser (Chrome, Safari, Firefox, Edge)<br>
                                    • Disable browser extensions temporarily
                                </div>
                            </details>
                            <details style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                                <summary style="cursor: pointer; font-weight: 600;">Sync issues between devices?</summary>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    • Ensure internet connection on both devices<br>
                                    • Verify same login credentials on all devices<br>
                                    • Try logging out and back in<br>
                                    • Use the 🔄 Refresh button to force sync
                                </div>
                            </details>
                        </div>

                        <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                                <strong>Technical:</strong> HTML/CSS/JavaScript • Firebase Backend • ~60KB total • Offline-first architecture
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <!-- Login Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <h3>Welcome to AI Task Tracker</h3>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    Sign in to sync your tasks across all devices, or continue using locally stored data.
                </p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-green" onclick="showLoginForm()" style="flex: 1;">
                        🔐 Sign In
                    </button>
                    <button class="btn btn-primary" onclick="showSignUpForm()" style="flex: 1;">
                        ➕ Create Account
                    </button>
                </div>
                
                <div id="loginForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Your password">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-green" onclick="signInWithForm()" style="flex: 1;">Sign In</button>
                        <button class="btn btn-secondary" onclick="hideLoginForm()">Back</button>
                    </div>
                </div>
                
                <div id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-input" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="signupPassword" class="form-input" placeholder="Create a password (6+ characters)">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="signUpWithForm()" style="flex: 1;">Create Account</button>
                        <button class="btn btn-secondary" onclick="hideSignUpForm()">Back</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="continueWithoutLogin()" style="text-decoration: underline;">
                        Continue without account (local storage only)
                    </button>
                </div>
            </div>
        </div>
        
        <script>

        // Firebase Configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyBgCyA2MQV7UFd9qTTZZeobaXj9NgsmrsU",
                    authDomain: "ai-task-tracker-d5541.firebaseapp.com",
                    databaseURL: "https://ai-task-tracker-d5541-default-rtdb.firebaseio.com",
                    projectId: "ai-task-tracker-d5541",
                    storageBucket: "ai-task-tracker-d5541.firebasestorage.app",
                    messagingSenderId: "34217557736",
                    appId: "1:34217557736:web:2895814d8935337c7c135d"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                const database = firebase.database();

                // Firebase Auth implementation
                function promptForUsername() {
                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            // User is signed in
                            currentUser = user.uid;
                            userDataRef = database.ref(`users/${currentUser}`);
                            showLoggedInState();
                            loadDataFromFirebase();
                        } else {
                            // User is signed out
                            showLoggedOutState();
                            loadLocalDataOnly();
                        }
                    });
                }

                function showLoggedInState() {
                    // Hide login button, show logout button
                    const logoutBtn = document.querySelector('[onclick="logOut()"]');
                    if (logoutBtn) logoutBtn.style.display = 'flex';
                    
                    const loginBtn = document.getElementById('loginBtn');
                    if (loginBtn) loginBtn.style.display = 'none';
                }

                function showLoggedOutState() {
                    // Show login button, hide logout button
                    const logoutBtn = document.querySelector('[onclick="logOut()"]');
                    if (logoutBtn) logoutBtn.style.display = 'none';
                    
                    // Create login button if it doesn't exist
                    if (!document.getElementById('loginBtn')) {
                        const loginBtn = document.createElement('button');
                        loginBtn.id = 'loginBtn';
                        loginBtn.className = 'btn btn-green';
                        loginBtn.innerHTML = '🔐 Log In / Sign Up';
                        loginBtn.onclick = showAuthModal;
                        
                        // Insert before logout button
                        const controls = document.querySelector('.app-controls');
                        const logoutBtn = document.querySelector('[onclick="logOut()"]');
                        controls.insertBefore(loginBtn, logoutBtn);
                    }
                    document.getElementById('loginBtn').style.display = 'flex';
                }

                function loadLocalDataOnly() {
                    // Load from localStorage without clearing existing data
                    const localData = localStorage.getItem('aiTaskTracker_workspaces');
                    const localOrder = localStorage.getItem('aiTaskTracker_workspaceOrder');
                    
                    if (localData && Object.keys(workspaces).length === 0) {
                        workspaces = JSON.parse(localData);
                    }
                    if (localOrder) {
                        workspaceOrder = JSON.parse(localOrder);
                    }
                    
                    renderWorkspaceTabs();
                    renderTasks();
                    updateArchiveCount();
                }
                function showAuthModal() {
                    showModal('loginModal');
                }

                function showLoginForm() {
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('signupForm').style.display = 'none';
                }

                function showSignUpForm() {
                    document.getElementById('signupForm').style.display = 'block';
                    document.getElementById('loginForm').style.display = 'none';
                }

                function hideLoginForm() {
                    document.getElementById('loginForm').style.display = 'none';
                }

                function hideSignUpForm() {
                    document.getElementById('signupForm').style.display = 'none';
                }

                function showHelpModal() {
                    showModal('helpModal');
                }
            
                function signInWithForm() {
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }
                    
                    firebase.auth().signInWithEmailAndPassword(email, password)
                        .then(() => {
                            closeModal();
                        })
                        .catch((error) => {
                            alert('Sign in failed: ' + error.message);
                            if (error.code === 'auth/user-not-found') {
                                if (confirm('Account not found. Create new account with this email?')) {
                                    signUpWithForm();
                                }
                            }
                        });
                }

                function signUpWithForm() {
                    const email = document.getElementById('signupEmail').value.trim() || document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('signupPassword').value || document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }
                    
                    if (password.length < 6) {
                        alert('Password must be at least 6 characters');
                        return;
                    }
                    
                    firebase.auth().createUserWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const initialData = {
                                workspaces: workspaces,
                                currentWorkspace: currentWorkspace,
                                appName: appName,
                                workspaceOrder: workspaceOrder,
                                lastUpdated: Date.now()
                            };
                            
                            const newUserRef = database.ref(`users/${userCredential.user.uid}`);
                            newUserRef.set(initialData);
                            closeModal();
                        })
                        .catch((error) => {
                            alert('Account creation failed: ' + error.message);
                        });
                }

                function continueWithoutLogin() {
                    closeModal();
                }

                function createAccountWithCredentials(email, password) {
                    firebase.auth().createUserWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            // Initialize default data for new user
                            const initialData = {
                                workspaces: {
                                    'Work': {
                                        emoji: '💼',
                                        tasks: [],
                                        completedTasks: [],
                                        taskCategories: []
                                    },
                                    'Personal': {
                                        emoji: '🏠',
                                        tasks: [],
                                        completedTasks: [],
                                        taskCategories: []
                                    }
                                },
                                currentWorkspace: 'Work',
                                appName: '🤖 AI Task Tracker',
                                lastUpdated: Date.now()
                            };
                            
                            const newUserRef = database.ref(`users/${userCredential.user.uid}`);
                            newUserRef.set(initialData);
                        })
                        .catch((error) => {
                            alert('Account creation failed: ' + error.message);
                            showAuthChoice();
                        });
                }

                function logOut() {
                    if (confirm('Are you sure you want to log out?')) {
                        firebase.auth().signOut().then(() => {
                            // Clear local data
                            currentUser = '';
                            disconnectRealtimeListener();
                            userDataRef = null;
                            workspaces = {};
                            location.reload();
                        });
                    }
                }
                
                // App State
                let workspaces = {};
                let currentWorkspace = 'Work';
                let showingArchive = false;
                let editingTaskId = null;
                let appName = '🤖 AI Task Tracker';
                let currentUser = localStorage.getItem('aiTaskTracker_currentUser') || '';
                let userDataRef = null;
                let workspaceOrder = ['Work', 'Personal'];

        // Initialize default workspace if none exist
        if (Object.keys(workspaces).length === 0) {
            workspaces = {
                'Work': {
                    emoji: '💼',
                    tasks: [],
                    completedTasks: [],
                    taskCategories: []
                },
                'Personal': {
                    emoji: '🏠',
                    tasks: [],
                    completedTasks: [],
                    taskCategories: []
                }
            };
            saveWorkspaces();
        }

        // Ensure current workspace exists and has emoji
        if (!workspaces[currentWorkspace]) {
            currentWorkspace = Object.keys(workspaces)[0];
        }
        
        // Add emoji to existing workspaces if missing
        Object.keys(workspaces).forEach(name => {
            if (!workspaces[name].emoji) {
                if (name === 'Work') workspaces[name].emoji = '💼';
                else if (name === 'Personal') workspaces[name].emoji = '🏠';
                else workspaces[name].emoji = '📁';
            }
        });

        // Fix existing workspaces that might be missing taskCategories
        Object.keys(workspaces).forEach(name => {
            const workspace = workspaces[name];
            if (!workspace.taskCategories) {
                workspace.taskCategories = [];
            }
        });
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            renderWorkspaceTabs();
            switchToWorkspace(currentWorkspace);
            updateAppName();
            promptForUsername();
        });

        function setupEventListeners() {
            // Quick input Enter key
            document.getElementById('quickInput').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    parseQuickInput();
                }
            });

            // Date input synchronization
            document.getElementById('taskDate').addEventListener('input', function(e) {
                // Don't auto-parse while user is typing, only on blur
                if (e.target.value.length >= 4) { // Only when they've typed enough
                    const parsed = parseFlexibleDate(e.target.value);
                    if (parsed !== e.target.value) {
                        e.target.value = parsed;
                        document.getElementById('taskDatePicker').value = formatDateForCalendar(parsed);
                    }
                }
            });

            document.getElementById('taskDate').addEventListener('blur', function(e) {
                const parsed = parseFlexibleDate(e.target.value);
                e.target.value = parsed;
                document.getElementById('taskDatePicker').value = formatDateForCalendar(parsed);
            });

            document.getElementById('taskDatePicker').addEventListener('change', function(e) {
                const formatted = formatDateFromCalendar(e.target.value);
                document.getElementById('taskDate').value = formatted;
            });

            // Form submission
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTask();
            });

            // New type input Enter key
            document.getElementById('newTypeName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addtaskCategory();
                }
            });

            // New workspace input Enter key
            document.getElementById('workspaceName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveWorkspaceChanges();
                }
            });
        }

        // Workspace Management
        function renderWorkspaceTabs() {
            const container = document.getElementById('workspaceTabs');
            
            // Use saved order, fallback to Object.keys if no order saved
            const orderedWorkspaces = workspaceOrder.filter(name => workspaces[name]);
            
            // Add any new workspaces not in the saved order
            Object.keys(workspaces).forEach(name => {
                if (!orderedWorkspaces.includes(name)) {
                    orderedWorkspaces.push(name);
                }
            });
            
            let html = '';
            orderedWorkspaces.forEach((name, index) => {
                const workspace = workspaces[name];
                const isActive = name === currentWorkspace;
                html += `
                    <div class="tab ${isActive ? 'active' : ''}" 
                         data-workspace="${name}"
                         data-index="${index}"
                         onclick="switchToWorkspace('${name}')">
                        <span>${workspace.emoji || '📁'}</span>
                        <span>${name}</span>
                    </div>
                `;
            });
            
            html += `
                <div class="add-tab" onclick="showWorkspaceModal()" title="Add workspace">
                    ➕
                </div>
                <div class="add-tab" onclick="showWorkspaceManagerModal()" title="Manage workspaces">
                    ⚙️
                </div>
            `;
            container.innerHTML = html;
        }

            function switchToWorkspace(workspaceName) {
                // Safety check - don't switch if workspace doesn't exist
                if (!workspaces[workspaceName]) {
                    console.error('Attempted to switch to non-existent workspace:', workspaceName);
                    return;
                }
                
                currentWorkspace = workspaceName;
                localStorage.setItem('aiTaskTracker_currentWorkspace', currentWorkspace);
                
                showingArchive = false;
                document.getElementById('workspaceTitle').textContent = `${workspaces[workspaceName].emoji || '📁'} ${workspaceName}`;
                
                renderWorkspaceTabs();
                renderTasks();
                updateArchiveCount();
            }

        function showWorkspaceModal() {
            document.getElementById('workspaceName').value = '';
            document.getElementById('workspaceEmoji').value = '';
            document.getElementById('workspaceModalTitle').textContent = 'Create New Workspace';
            document.getElementById('workspaceSubmitBtn').textContent = 'Create';
            window.editingWorkspace = null;
            showModal('workspaceModal');
        }

        function showWorkspaceManagerModal() {
            renderWorkspaceManager();
            showModal('workspaceManagerModal');
        }

        function moveWorkspace(workspaceName, direction) {
            const currentIndex = workspaceOrder.indexOf(workspaceName);
            if (currentIndex === -1) return;
            
            const newOrder = [...workspaceOrder];
            
            if (direction === 'up' && currentIndex > 0) {
                // Move up: swap with previous item
                [newOrder[currentIndex], newOrder[currentIndex - 1]] = [newOrder[currentIndex - 1], newOrder[currentIndex]];
                workspaceOrder = newOrder;
                saveWorkspaces();
                renderWorkspaceManager();
                renderWorkspaceTabs();
            } else if (direction === 'down' && currentIndex < newOrder.length - 1) {
                // Move down: swap with next item
                [newOrder[currentIndex], newOrder[currentIndex + 1]] = [newOrder[currentIndex + 1], newOrder[currentIndex]];
                workspaceOrder = newOrder;
                saveWorkspaces();
                renderWorkspaceManager();
                renderWorkspaceTabs();
            }
        }
        
        function renderWorkspaceManager() {
            const container = document.getElementById('workspaceManagerList');
            
            // Use the saved order for display
            const orderedWorkspaces = workspaceOrder.filter(name => workspaces[name]);
            Object.keys(workspaces).forEach(name => {
                if (!orderedWorkspaces.includes(name)) {
                    orderedWorkspaces.push(name);
                }
            });
            
            const html = orderedWorkspaces.map((name, index) => {
                const workspace = workspaces[name];
                return `
                    <div class="workspace-item">
                        <div class="workspace-info">
                            <span class="workspace-emoji">${workspace.emoji || '📁'}</span>
                            <span class="workspace-name">${name}</span>
                            <span class="workspace-stats">(${workspace.tasks.length} tasks)</span>
                        </div>
                        <div class="workspace-actions">
                            ${index > 0 ? `
                                <button class="action-btn" onclick="moveWorkspace('${name}', 'up')" title="Move Up" style="background: #eff6ff; color: #2563eb;">
                                    ⬆️
                                </button>
                            ` : ''}
                            ${index < orderedWorkspaces.length - 1 ? `
                                <button class="action-btn" onclick="moveWorkspace('${name}', 'down')" title="Move Down" style="background: #eff6ff; color: #2563eb;">
                                    ⬇️
                                </button>
                            ` : ''}
                            <button class="action-btn edit-btn" onclick="editWorkspace('${name}')" title="Edit">
                                ✏️
                            </button>
                            ${orderedWorkspaces.length > 1 ? `
                                <button class="action-btn delete-btn" onclick="deleteWorkspace('${name}')" title="Delete">
                                    🗑️
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function editWorkspace(workspaceName) {
            const workspace = workspaces[workspaceName];
            document.getElementById('workspaceName').value = workspaceName;
            document.getElementById('workspaceEmoji').value = workspace.emoji || '';
            document.getElementById('workspaceModalTitle').textContent = 'Edit Workspace';
            document.getElementById('workspaceSubmitBtn').textContent = 'Save';
            window.editingWorkspace = workspaceName;
            closeModal(); // Close manager modal
            showModal('workspaceModal');
        }

        function saveWorkspaceChanges() {
            const newName = document.getElementById('workspaceName').value.trim();
            const newEmoji = document.getElementById('workspaceEmoji').value || '📁';
            
            if (!newName) return;
            
            if (window.editingWorkspace) {
                const oldName = window.editingWorkspace;
                if (newName !== oldName) {
                    // Rename workspace
                    workspaces[newName] = { ...workspaces[oldName], emoji: newEmoji };
                    delete workspaces[oldName];
                    if (currentWorkspace === oldName) {
                        currentWorkspace = newName;
                        localStorage.setItem('aiTaskTracker_currentWorkspace', currentWorkspace);
                    }
                } else {
                    // Just update emoji
                    workspaces[newName].emoji = newEmoji;
                }
            } else {
                // Create new workspace
                if (workspaces[newName]) return;
                workspaces[newName] = {
                    emoji: newEmoji,
                    tasks: [],
                    completedTasks: [],
                    taskCategories: [],
                    enabledFields: {
                        taskName: true,        // always required
                        priorityLowHigh: true, // default enabled
                        dueDate: true,         // default enabled
                        categories: true,      // default enabled
                        timeEstimate: false,   // optional
                        priorityP0P3: false    // optional
                    }
                };
                switchToWorkspace(newName);
            }
            
            saveWorkspaces();
            renderWorkspaceTabs();
            if (currentWorkspace === newName) {
                document.getElementById('workspaceTitle').textContent = `${workspaces[newName].emoji} ${newName}`;
            }
            closeModal();
        }

        function deleteWorkspace(workspaceName) {
            if (Object.keys(workspaces).length <= 1) return;
            
            if (confirm(`Delete "${workspaceName}" workspace? This will permanently delete all tasks and data.`)) {
                delete workspaces[workspaceName];
                saveWorkspaces();
                
                if (workspaceName === currentWorkspace) {
                    const remainingWorkspaces = Object.keys(workspaces);
                    switchToWorkspace(remainingWorkspaces[0]);
                } else {
                    renderWorkspaceTabs();
                }
                
                renderWorkspaceManager();
            }
        }

        // Field Configuration Management
        function showFieldConfigModal() {
            const workspaceName = currentWorkspace;
            document.getElementById('fieldConfigWorkspaceName').textContent = workspaceName;
            renderFieldConfig();
            showModal('fieldConfigModal');
        }

        function renderFieldConfig() {
            const enabledFields = getCurrentEnabledFields();
            const container = document.getElementById('fieldConfigList');
            
            const fieldOptions = [
                { key: 'taskName', label: 'Task Name', description: 'Always required', disabled: true },
                { key: 'dueDate', label: 'Due Date', description: 'When the task should be completed' },
                { key: 'priorityLowHigh', label: 'Priority: Low-High', description: 'Low, Medium, High, Critical priority system' },
                { key: 'priorityP0P3', label: 'Priority: P0-P3', description: 'P0 (Critical) to P3 (Low) priority system' },
                { key: 'timeEstimate', label: 'Time Estimate', description: 'How long the task should take' },
                { key: 'categories', label: 'Categories', description: 'Custom task categories' }
            ];
            
            const html = fieldOptions.map(field => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border-color);">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                            ${field.label}
                            ${field.disabled ? '<span style="color: var(--text-tertiary); font-weight: normal;">(Required)</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${field.description}
                        </div>
                    </div>
                    <div>
                        <input 
                            type="checkbox" 
                            id="field-${field.key}" 
                            ${enabledFields[field.key] ? 'checked' : ''} 
                            ${field.disabled ? 'disabled' : ''}
                            style="transform: scale(1.2); cursor: ${field.disabled ? 'not-allowed' : 'pointer'};"
                        />
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function saveFieldConfig() {
            const workspace = getCurrentWorkspace();
            const newEnabledFields = {
                taskName: true, // Always required
                dueDate: document.getElementById('field-dueDate').checked,
                priorityLowHigh: document.getElementById('field-priorityLowHigh').checked,
                priorityP0P3: document.getElementById('field-priorityP0P3').checked,
                timeEstimate: document.getElementById('field-timeEstimate').checked,
                categories: document.getElementById('field-categories').checked
            };
            
            workspace.enabledFields = newEnabledFields;
            saveWorkspaces();
            closeModal();
        }

        function showDefaultsModal() {
            const workspaceName = currentWorkspace;
            document.getElementById('defaultsWorkspaceName').textContent = workspaceName;
            renderDefaults();
            showModal('defaultsModal');
        }

        function renderDefaults() {
            const enabledFields = getCurrentEnabledFields();
            const workspace = getCurrentWorkspace();
            const defaults = workspace.fieldDefaults || {};
            const container = document.getElementById('defaultsList');
            
            let html = '';
            
            if (enabledFields.dueDate) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Default Due Date</label>
                        <select id="default-dueDate" class="form-select">
                            <option value="">No default</option>
                            <option value="today" ${defaults.dueDate === 'today' ? 'selected' : ''}>Today</option>
                            <option value="tomorrow" ${defaults.dueDate === 'tomorrow' ? 'selected' : ''}>Tomorrow</option>
                            <option value="nextWeek" ${defaults.dueDate === 'nextWeek' ? 'selected' : ''}>Next Monday</option>
                        </select>
                    </div>
                `;
            }
            
            if (enabledFields.priorityLowHigh) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Default Priority (Low-High)</label>
                        <select id="default-priorityLowHigh" class="form-select">
                            <option value="">No default</option>
                            <option value="Low" ${defaults.priorityLowHigh === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${defaults.priorityLowHigh === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${defaults.priorityLowHigh === 'High' ? 'selected' : ''}>High</option>
                            <option value="Critical" ${defaults.priorityLowHigh === 'Critical' ? 'selected' : ''}>Critical</option>
                        </select>
                    </div>
                `;
            }
            
            if (enabledFields.priorityP0P3) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Default Priority (P0-P3)</label>
                        <select id="default-priorityP0P3" class="form-select">
                            <option value="">No default</option>
                            <option value="P0" ${defaults.priorityP0P3 === 'P0' ? 'selected' : ''}>P0 - Critical</option>
                            <option value="P1" ${defaults.priorityP0P3 === 'P1' ? 'selected' : ''}>P1 - High</option>
                            <option value="P2" ${defaults.priorityP0P3 === 'P2' ? 'selected' : ''}>P2 - Medium</option>
                            <option value="P3" ${defaults.priorityP0P3 === 'P3' ? 'selected' : ''}>P3 - Low</option>
                        </select>
                    </div>
                `;
            }
            
            if (enabledFields.timeEstimate) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Default Time Estimate (minutes)</label>
                        <select id="default-timeEstimate" class="form-select">
                            <option value="">No default</option>
                            <option value="15" ${defaults.timeEstimate === 15 ? 'selected' : ''}>15 minutes</option>
                            <option value="30" ${defaults.timeEstimate === 30 ? 'selected' : ''}>30 minutes</option>
                            <option value="60" ${defaults.timeEstimate === 60 ? 'selected' : ''}>1 hour</option>
                            <option value="120" ${defaults.timeEstimate === 120 ? 'selected' : ''}>2 hours</option>
                            <option value="240" ${defaults.timeEstimate === 240 ? 'selected' : ''}>4 hours</option>
                        </select>
                    </div>
                `;
            }
            
            if (enabledFields.categories) {
                const categories = getCurrentTaskCategories();
                let categoryOptions = '<option value="">No default</option>';
                categoryOptions += '<option value="General" ' + (defaults.taskCategory === 'General' ? 'selected' : '') + '>General</option>';
                categories.forEach(cat => {
                    categoryOptions += `<option value="${cat}" ${defaults.taskCategory === cat ? 'selected' : ''}>${cat}</option>`;
                });
                
                html += `
                    <div class="form-group">
                        <label class="form-label">Default Category</label>
                        <select id="default-taskCategory" class="form-select">
                            ${categoryOptions}
                        </select>
                    </div>
                `;
            }
            
            if (!html) {
                html = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No fields enabled for defaults.</p>';
            }
            
            container.innerHTML = html;
        }

        function saveDefaults() {
            const workspace = getCurrentWorkspace();
            const enabledFields = getCurrentEnabledFields();
            const defaults = {};
            
            if (enabledFields.dueDate) {
                const value = document.getElementById('default-dueDate').value;
                if (value) defaults.dueDate = value;
            }
            
            if (enabledFields.priorityLowHigh) {
                const value = document.getElementById('default-priorityLowHigh').value;
                if (value) defaults.priorityLowHigh = value;
            }
            
            if (enabledFields.priorityP0P3) {
                const value = document.getElementById('default-priorityP0P3').value;
                if (value) defaults.priorityP0P3 = value;
            }
            
            if (enabledFields.timeEstimate) {
                const value = document.getElementById('default-timeEstimate').value;
                if (value) defaults.timeEstimate = parseInt(value);
            }
            
            if (enabledFields.categories) {
                const value = document.getElementById('default-taskCategory').value;
                if (value) defaults.taskCategory = value;
            }
            
            workspace.fieldDefaults = defaults;
            saveWorkspaces();
            closeModal();
        }

        function applyFieldDefaults() {
            const workspace = getCurrentWorkspace();
            const defaults = workspace.fieldDefaults || {};
            const enabledFields = getCurrentEnabledFields();
            
            // Apply due date default
            if (enabledFields.dueDate && defaults.dueDate) {
                let defaultDate = '';
                if (defaults.dueDate === 'today') {
                    defaultDate = getTodayDateString();
                } else if (defaults.dueDate === 'tomorrow') {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    defaultDate = formatDate(tomorrow);
                } else if (defaults.dueDate === 'nextWeek') {
                    defaultDate = getNextWeekday(1); // Next Monday
                }
                if (defaultDate) {
                    document.getElementById('taskDate').value = defaultDate;
                    document.getElementById('taskDatePicker').value = formatDateForCalendar(defaultDate);
                }
            }
            
            // Apply priority defaults
            if (enabledFields.priorityLowHigh && defaults.priorityLowHigh) {
                document.getElementById('taskPriority').value = defaults.priorityLowHigh;
            } else if (enabledFields.priorityP0P3 && defaults.priorityP0P3) {
                document.getElementById('taskPriority').value = defaults.priorityP0P3;
            }
            
            // Apply time estimate default
            if (enabledFields.timeEstimate && defaults.timeEstimate) {
                document.getElementById('taskTime').value = defaults.timeEstimate;
            }
            
            // Apply category default
            if (enabledFields.categories && defaults.taskCategory) {
                document.getElementById('taskCategory').value = defaults.taskCategory;
            }
        }
        
        // Get current workspace data
        function getCurrentWorkspace() {
            return workspaces[currentWorkspace];
        }

        function getCurrentTasks() {
            return getCurrentWorkspace().tasks;
        }

        function getCurrentCompletedTasks() {
            return getCurrentWorkspace().completedTasks;
        }

        function getCurrentTaskCategories() {
            const workspace = getCurrentWorkspace();
            return workspace.taskCategories || [];
        }

        function getPriorityLowHighOptions() {
            return getCurrentWorkspace().priorityLowHighOptions || ['Low', 'Medium', 'High', 'Critical'];
        }

        function getCurrentEnabledFields() {
            return getCurrentWorkspace().enabledFields || {
                taskName: true,
                priorityLowHigh: true,
                dueDate: true,
                categories: true,
                timeEstimate: false,
                priorityP0P3: false
            };
        }
        
        // Date parsing functions
        function parseFlexibleDate(input) {
            if (!input) return '';
            
            const parts = input.split('/');
            if (parts.length < 2) return input;
            
            let month = parseInt(parts[0]);
            let day = parseInt(parts[1]);
            let year = parts[2] ? parseInt(parts[2]) : null;
            
            if (year && year < 100) {
                year = year + 2000;
            }
            
            if (!year) {
                // Smart year logic: find next occurrence of MM/DD
                const today = new Date();
                const currentYear = today.getFullYear();
                const targetDate = new Date(currentYear, month - 1, day);
                
                if (targetDate <= today) {
                    // If date has passed this year, use next year
                    year = currentYear + 1;
                } else {
                    year = currentYear;
                }
            }
            
            if (month < 1 || month > 12 || day < 1 || day > 31) {
                return input;
            }
            
            return `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        }

        function formatDateForCalendar(dateStr) {
            if (!dateStr) return '';
            const [month, day] = dateStr.split('/').map(num => parseInt(num));
            const currentYear = new Date().getFullYear();
            return `${currentYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }

        function formatDateFromCalendar(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00'); // Add time to prevent timezone issues
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        // AI Parsing
        async function parseQuickInput() {
            const input = document.getElementById('quickInput').value.trim();
            if (!input) return;

            const status = document.getElementById('parseStatus');
            status.textContent = 'Parsing task...';
            status.className = 'parsing-status status-parsing';
            status.style.display = 'block';

            try {
                const taskData = parseTaskWithPatterns(input);
                
                // Check if essential fields are missing (only for enabled fields)
                const enabledFields = getCurrentEnabledFields();
                const missingFields = [];

                if (enabledFields.dueDate && (!taskData.dueDate || taskData.dueDate === getTodayDateString())) {
                    missingFields.push('due date');
                }
                if (enabledFields.timeEstimate && taskData.timeEstimate === 60) {
                    missingFields.push('time estimate');
                }
                if (enabledFields.categories && taskData.taskCategory === 'General') {
                    missingFields.push('category');
                }
                
                if (missingFields.length > 0) {
                    // Show modal with pre-filled data and missing field indicators
                    showTaskModalWithData(taskData, missingFields);
                } else {
                    // All fields captured, add directly
                    addTaskDirectly(taskData);
                }
                
                status.style.display = 'none';
                document.getElementById('quickInput').value = '';

            } catch (error) {
                console.error('Parsing error:', error);
                status.textContent = 'Could not parse task. Try manual add instead.';
                status.className = 'parsing-status status-error';
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
        
        function addTaskDirectly(taskData) {
            const newTask = {
                id: Date.now(),
                name: taskData.name,
                dueDate: taskData.dueDate,
                priority: taskData.priority,
                timeEstimate: taskData.timeEstimate,
                taskCategory: taskData.taskCategory
            };

            getCurrentWorkspace().tasks.push(newTask);
            saveWorkspaces();
            renderTasks();
            
            // Show success message briefly
            const status = document.getElementById('parseStatus');
            status.textContent = 'Task added successfully!';
            status.className = 'parsing-status status-success';
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 2000);
        }

        function showTaskModalWithData(taskData, missingFields) {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Complete Task Details';
            
            // Pre-fill the form with parsed data
            document.getElementById('taskName').value = taskData.name;
            document.getElementById('taskDate').value = taskData.dueDate;
            document.getElementById('taskDatePicker').value = formatDateForCalendar(taskData.dueDate);
            document.getElementById('taskPriority').value = taskData.priority;
            document.getElementById('taskTime').value = taskData.timeEstimate;
            updateTaskCategorySelects();
            document.getElementById('taskCategory').value = taskData.taskCategory;
            
            // Add visual indicators for missing fields
            highlightMissingFields(missingFields);
            
            showModal('taskModal');
        }

        function highlightMissingFields(missingFields) {
            // Remove any existing highlights
            document.querySelectorAll('.missing-field').forEach(el => el.classList.remove('missing-field'));
            document.querySelectorAll('.field-note').forEach(el => el.remove());
            
            // Only highlight fields that actually got filled with defaults during parsing
            missingFields.forEach(field => {
                let element;
                let shouldHighlight = false;
                
                if (field === 'due date') {
                    element = document.getElementById('taskDate').parentNode;
                    // Only highlight if it's actually today's date (the default)
                    shouldHighlight = document.getElementById('taskDate').value === getTodayDateString();
                } else if (field === 'time estimate') {
                    element = document.getElementById('taskTime').parentNode;
                    // Only highlight if it's exactly 60 minutes (the default)
                    shouldHighlight = document.getElementById('taskTime').value === '60';
                } else if (field === 'category') {
                    element = document.getElementById('taskCategory').parentNode;
                    // Only highlight if it's General (the default)
                    shouldHighlight = document.getElementById('taskCategory').value === 'General';
                }
                
                // Only add styling if it's actually using a default value
                if (element && shouldHighlight) {
                    // Just add red text, no background box
                    const note = document.createElement('div');
                    note.className = 'field-note';
                    note.style.color = '#dc2626';
                    note.style.fontSize = '11px';
                    note.style.marginTop = '4px';
                    note.textContent = '(using default - you can change this)';
                    element.appendChild(note);
                }
            });
        }
        
        function parseTaskWithPatterns(input) {
            const originalInput = input;
            let text = input.toLowerCase();
            
            // Extract priority
            const enabledFields = getCurrentEnabledFields();
            let priority = enabledFields.priorityLowHigh ? 'Medium' : 'P2'; // default based on enabled system

            // Check for Low-High priority system first
            if (enabledFields.priorityLowHigh) {
                if (text.includes('critical')) {
                    priority = 'Critical';
                } else if (text.includes('high priority') || text.includes('high') || text.includes('important')) {
                    priority = 'High';
                } else if (text.includes('low priority') || text.includes('low')) {
                    priority = 'Low';
                } else if (text.includes('medium')) {
                    priority = 'Medium';
                }
            }

            // Check for P0-P3 system if enabled
            if (enabledFields.priorityP0P3) {
                if (text.includes('urgent') || text.includes('critical') || text.includes('p0')) {
                    priority = 'P0';
                } else if (text.includes('high priority') || text.includes('high') || text.includes('important') || text.includes('p1')) {
                    priority = 'P1';
                } else if (text.includes('p2')) {
                    priority = 'P2';
                } else if (text.includes('low priority') || text.includes('low') || text.includes('p3')) {
                    priority = 'P3';
                }
            }
            
            // Extract time estimate
            let timeEstimate = 60; // default 1 hour
            const timePatterns = [
                /(\d+)\s*hours?/,
                /(\d+)\s*hrs?/,
                /(\d+)\s*h\b/,
                /(\d+)\s*minutes?/,
                /(\d+)\s*mins?/,
                /(\d+)\s*m\b/
            ];
            
            for (let pattern of timePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const num = parseInt(match[1]);
                    if (pattern.source.includes('hour') || pattern.source.includes('hr') || pattern.source.includes('h\\b')) {
                        timeEstimate = num * 60;
                    } else {
                        timeEstimate = num;
                    }
                    break;
                }
            }
            
            // Extract due date
            let dueDate = getTodayDateString();
            const now = new Date();
            
            // Extract MM/DD date patterns first
            const dateMatch = text.match(/\b(\d{1,2})\/(\d{1,2})(?:\/\d{2,4})?\b/);
            if (dateMatch) {
                const month = parseInt(dateMatch[1]);
                const day = parseInt(dateMatch[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // Use the smart year logic
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    const targetDate = new Date(currentYear, month - 1, day);
                    
                    if (targetDate <= today) {
                        // If date has passed this year, use next year (but still format as MM/DD)
                        dueDate = `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
                        } else {
                            dueDate = `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
                    }
                }
            } else if (text.includes('tomorrow')) {
                const tomorrow = new Date(now);
                tomorrow.setDate(now.getDate() + 1);
                dueDate = formatDate(tomorrow);
            } else if (text.includes('today')) {
                dueDate = getTodayDateString();
            } else if (text.includes('friday')) {
                dueDate = getNextWeekday(5); // Friday
            } else if (text.includes('monday')) {
                dueDate = getNextWeekday(1);
            } else if (text.includes('tuesday')) {
                dueDate = getNextWeekday(2);
            } else if (text.includes('wednesday')) {
                dueDate = getNextWeekday(3);
            } else if (text.includes('thursday')) {
                dueDate = getNextWeekday(4);
            } else if (text.includes('saturday')) {
                dueDate = getNextWeekday(6);
            } else if (text.includes('sunday')) {
                dueDate = getNextWeekday(0);
            } else if (text.includes('next week')) {
                const nextWeek = new Date(now);
                nextWeek.setDate(now.getDate() + 7);
                dueDate = formatDate(nextWeek);
            }
            
            // Extract Task Category
            let taskCategory = 'General';
            const availableCategories = getCurrentTaskCategories();
            for (let category of availableCategories) {
                // Handle both old string format and new object format
                const categoryName = typeof category === 'string' ? category : category.name;
                if (text.includes(categoryName.toLowerCase())) {
                    taskCategory = categoryName;
                    break;
                }
            }
            
            // Clean up task name
            let taskName = originalInput
                .replace(/\b(urgent|critical|high priority|high|important|low priority|low|p0|p1|p2|p3)\b/gi, '')
                .replace(/\b\d+\s*m\b/gi, '') // Remove time patterns like "5m"
                .replace(/\b\d+\s*(min|mins|minutes|hour|hours|hrs?)\b/gi, '')
                .replace(/\b(tomorrow|today|friday|monday|tuesday|wednesday|thursday|saturday|sunday|next week)\b/gi, '')
                .replace(/\b\d{1,2}\/\d{1,2}(?:\/\d{2,4})?\b/gi, '') // Remove MM/DD or MM/DD/YY patterns
                .replace(/\s+/g, ' ')
                .trim();
            
            // Remove Task Category from name if it was detected
            if (taskCategory !== 'General') {
                taskName = taskName.replace(new RegExp(taskCategory, 'gi'), '').replace(/\s+/g, ' ').trim();
            }
            
            // Ensure task name isn't empty
            if (!taskName) {
                taskName = 'New Task';
            }
            
            return {
                name: taskName,
                dueDate: dueDate,
                priority: priority,
                timeEstimate: timeEstimate,
                taskCategory: taskCategory
            };
        }

        function getTodayDateString() {
            const today = new Date();
            return formatDate(today);
        }

        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        }

        function getNextWeekday(targetDay) {
            const today = new Date();
            const currentDay = today.getDay();
            let daysUntilTarget = targetDay - currentDay;
            
            if (daysUntilTarget <= 0) {
                daysUntilTarget += 7; // Next week
            }
            
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysUntilTarget);
            return formatDate(targetDate);
        }
        
        // Task Management
        function addTask(taskData) {
            const newTask = {
                id: Date.now(),
                ...taskData
            };
            getCurrentWorkspace().tasks.push(newTask);
            saveWorkspaces();
            renderTasks();
        }

        function completeTask(taskId) {
            const workspace = getCurrentWorkspace();
            const task = workspace.tasks.find(t => t.id === taskId);
            if (task) {
                const completedTask = {
                    ...task,
                    completedAt: new Date().toLocaleString()
                };
                workspace.completedTasks.unshift(completedTask);
                workspace.tasks = workspace.tasks.filter(t => t.id !== taskId);
                saveWorkspaces();
                renderTasks();
                updateArchiveCount();
            }
        }

        function deleteTask(taskId) {
            getCurrentWorkspace().tasks = getCurrentWorkspace().tasks.filter(t => t.id !== taskId);
            saveWorkspaces();
            renderTasks();
        }

        function editTask(taskId) {
            const task = getCurrentTasks().find(t => t.id === taskId);
            if (task) {
                editingTaskId = taskId;
                document.getElementById('modalTitle').textContent = 'Edit Task';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDate').value = task.dueDate;
                document.getElementById('taskDatePicker').value = formatDateForCalendar(task.dueDate);
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskTime').value = task.timeEstimate;
                document.getElementById('taskCategory').value = task.taskCategory || 'General';
                document.getElementById('taskNotes').value = task.notes || '';
                updatePrioritySelects();
                updateTaskCategorySelects();
                updateModalFieldVisibility();
                showModal('taskModal');
            }
        }

        function clearValidationErrors() {
            // Remove error styling from all fields
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
            // Hide all error messages
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        }

        function showFieldError(fieldId, show = true) {
            const field = document.getElementById(fieldId);
            const errorMsg = document.getElementById(fieldId + 'Error');
            
            if (show) {
                field.classList.add('field-error');
                errorMsg.style.display = 'block';
            } else {
                field.classList.remove('field-error');
                errorMsg.style.display = 'none';
            }
        }

        function validateTaskForm() {
            clearValidationErrors();
            const enabledFields = getCurrentEnabledFields();
            let isValid = true;
            
            // Task name is always required
            if (!document.getElementById('taskName').value.trim()) {
                showFieldError('taskName');
                isValid = false;
            }
            
            // Validate enabled fields only
            if (enabledFields.dueDate && !document.getElementById('taskDate').value.trim()) {
                showFieldError('taskDate');
                isValid = false;
            }
            
            if (enabledFields.timeEstimate && !document.getElementById('taskTime').value) {
                showFieldError('taskTime');
                isValid = false;
            }
            
            return isValid;
            }

            function setupFieldValidationListeners() {
                // Clear errors when user starts typing/selecting
                document.getElementById('taskName').addEventListener('input', () => showFieldError('taskName', false));
                document.getElementById('taskDate').addEventListener('input', () => showFieldError('taskDate', false));
                document.getElementById('taskTime').addEventListener('input', () => showFieldError('taskTime', false));
                document.getElementById('taskPriority').addEventListener('change', () => showFieldError('taskPriority', false));
                document.getElementById('taskCategory').addEventListener('change', () => showFieldError('taskCategory', false));
            }
        
        function saveTask() {
            const enabledFields = getCurrentEnabledFields();
            const name = document.getElementById('taskName').value.trim();
            
            if (!name) return; // Task name is always required
            
            // Only get values from enabled fields
            let taskData = { name };
            
            if (enabledFields.dueDate) {
                const dueDate = document.getElementById('taskDate').value;
                if (!dueDate) return; // Required if enabled
                taskData.dueDate = dueDate;
            } else {
                taskData.dueDate = getTodayDateString(); // Default for disabled field
            }
            
            if (enabledFields.priorityLowHigh || enabledFields.priorityP0P3) {
                taskData.priority = document.getElementById('taskPriority').value;
            } else {
                taskData.priority = 'Medium'; // Default priority
            }
            
            if (enabledFields.timeEstimate) {
                const timeEstimate = parseInt(document.getElementById('taskTime').value);
                if (!timeEstimate) return; // Required if enabled
                taskData.timeEstimate = timeEstimate;
            } else {
                taskData.timeEstimate = 60; // Default 1 hour
            }
            
            if (enabledFields.categories) {
                taskData.taskCategory = document.getElementById('taskCategory').value || 'General';
            } else {
                taskData.taskCategory = 'General';
            }

            // Add notes support
            if (document.getElementById('taskNotes')) {
                taskData.notes = document.getElementById('taskNotes').value.trim();
            }
            
            if (editingTaskId) {
                const tasks = getCurrentWorkspace().tasks;
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                }
                editingTaskId = null;
            } else {
                addTask(taskData);
            }

            saveWorkspaces();
            renderTasks();
            closeModal();
        }

        // Date categorization
        function categorizeTasksByDate(taskList) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const dayOfWeek = today.getDay();
            const daysUntilFriday = dayOfWeek <= 5 ? 5 - dayOfWeek : 0;
            const thisFriday = new Date(today);
            thisFriday.setDate(today.getDate() + daysUntilFriday);
            
            const nextFriday = new Date(thisFriday);
            nextFriday.setDate(thisFriday.getDate() + 7);

            const categories = {
                overdue: [],
                today: [],
                thisWeek: [],
                nextWeek: [],
                future: []
            };

            taskList.forEach(task => {
                const [month, day] = task.dueDate.split('/').map(n => parseInt(n));
                const taskDate = new Date(now.getFullYear(), month - 1, day);

                if (taskDate < today) {
                    categories.overdue.push(task);
                } else if (taskDate.getTime() === today.getTime()) {
                    categories.today.push(task);
                } else if (taskDate <= thisFriday) {
                    categories.thisWeek.push(task);
                } else if (taskDate <= nextFriday) {
                    categories.nextWeek.push(task);
                } else {
                    categories.future.push(task);
                }
            });

            // Sort by priority within each category
            Object.keys(categories).forEach(category => {
                categories[category].sort((a, b) => {
                    const priorityA = parseInt(a.priority.substring(1));
                    const priorityB = parseInt(b.priority.substring(1));
                    return priorityA - priorityB;
                });
            });

            return categories;
        }

        // Rendering
        function renderTasks() {
            const container = document.getElementById('taskSections');
            const emptyState = document.getElementById('emptyState');

            if (showingArchive) {
                renderArchive();
                return;
            }

            const tasks = getCurrentTasks();
            if (tasks.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            const categorized = categorizeTasksByDate(tasks);
            
            const sections = [
                { key: 'overdue', title: 'Overdue', class: 'overdue' },
                { key: 'today', title: 'Today', class: 'today' },
                { key: 'thisWeek', title: 'This Week', class: 'this-week' },
                { key: 'nextWeek', title: 'Next Week', class: 'next-week' },
                { key: 'future', title: 'Future', class: 'future' }
            ];

            let html = '';
            sections.forEach(section => {
                const sectionTasks = categorized[section.key];
                if (sectionTasks.length > 0) {
                    html += `
                        <div class="task-section">
                            <div class="section-header ${section.class}">
                                <span>${section.title} (${sectionTasks.length})</span>
                            </div>
                            <div class="task-list">
                                ${sectionTasks.map(task => renderTaskCard(task)).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        function renderTaskCard(task, isArchived = false) {
            const enabledFields = getCurrentEnabledFields();
            
            // Build metadata items as HTML spans with proper styling
            let metaItems = [];
            
            if (enabledFields.dueDate) {
                metaItems.push(`<span>📅 ${task.dueDate}</span>`);
            }
            
            if (enabledFields.priorityLowHigh || enabledFields.priorityP0P3) {
                metaItems.push(`<span>${task.priority}</span>`);
            }
            
            if (enabledFields.categories && task.taskCategory && task.taskCategory !== 'General') {
                const categories = getCurrentTaskCategories();
                const categoryObj = categories.find(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.name;
                    return catName === task.taskCategory;
                });
                
                if (categoryObj) {
                    const categoryName = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
                    const categoryEmoji = typeof categoryObj === 'string' ? '' : (categoryObj.emoji || '');
                    const categoryColor = typeof categoryObj === 'string' ? 'blue' : (categoryObj.color || 'blue');
                    
                    const displayText = categoryEmoji ? `${categoryEmoji} ${categoryName}` : categoryName;
                    // Apply the proper CSS class for coloring
                    metaItems.push(`<span class="meta-item category-${categoryColor}">${displayText}</span>`);
                }
            }
            
            if (enabledFields.timeEstimate) {
                metaItems.push(`<span>⏱️ ${task.timeEstimate}m</span>`);
            }
            
            if (isArchived) {
                metaItems.push(`<span>✅ ${task.completedAt}</span>`);
            }
            
            // Join meta items with bullet separator
            const metaText = metaItems.length > 0 ? ' • ' + metaItems.join(' • ') : '';
            
            return `
                <div class="task-card ${isArchived ? 'archive-task' : ''}">
                    <div class="task-header-compact">
                        <div class="task-content">
                            <div class="task-title-line">
                                <span class="task-name">${task.name}</span><span class="task-meta-text">${metaText}</span>
                            </div>
                            <div class="task-notes" id="notes-${task.id}" style="display: none; margin-top: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 13px; color: var(--text-secondary); border-left: 3px solid var(--blue);">
                                ${task.notes || ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            ${task.notes ? `
                                <button class="action-btn edit-btn" onclick="toggleNotes(${task.id})" title="View Notes">
                                    📝
                                </button>
                            ` : ''}
                            ${!isArchived ? `
                                <button class="action-btn complete-btn" onclick="completeTask(${task.id})" title="Complete">✓</button>
                                <button class="action-btn edit-btn" onclick="editTask(${task.id})" title="Edit">✏️</button>
                            ` : ''}
                            <button class="action-btn delete-btn" onclick="${isArchived ? 'deleteFromArchive' : 'deleteTask'}(${task.id})" title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderArchive() {
            const container = document.getElementById('taskSections');
            const emptyState = document.getElementById('emptyState');
            const completedTasks = getCurrentCompletedTasks();

            if (completedTasks.length === 0) {
                container.innerHTML = '';
                emptyState.innerHTML = '<h3>No completed tasks yet!</h3><p>Complete some tasks to see them here.</p>';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            const html = `
                <div class="task-section">
                    <div class="section-header" style="border-color: #059669; color: #047857;">
                        <span>📁 Completed Tasks (${completedTasks.length})</span>
                    </div>
                    <div class="task-list">
                        ${completedTasks.map(task => renderTaskCard(task, true)).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        let editingCategoryIndex = null;

                function editCategory(index) {
                    const taskCategories = getCurrentTaskCategories();
                    const category = taskCategories[index];
                    
                    // Handle both old string format and new object format
                    const categoryName = typeof category === 'string' ? category : category.name;
                    const categoryEmoji = typeof category === 'string' ? '📁' : (category.emoji || '📁');
                    const categoryColor = typeof category === 'string' ? 'blue' : (category.color || 'blue');
                    
                    // Pre-fill the form with existing data
                    document.getElementById('newTypeName').value = categoryName;
                    document.getElementById('newTypeEmoji').value = categoryEmoji;
                    document.getElementById('newTypeColor').value = categoryColor;
                    
                    // Change the button text and track editing mode
                    const addButton = document.querySelector('button[onclick="addtaskCategory()"]');
                    addButton.textContent = 'Update';
                    addButton.setAttribute('onclick', `updateCategory(${index})`);
                    
                    editingCategoryIndex = index;
                }

                function updateCategory(index) {
                    const name = document.getElementById('newTypeName').value.trim();
                    const emoji = document.getElementById('newTypeEmoji').value.trim() || '📁';
                    if (emoji && emoji.length > 2) {
                        alert('Emoji should be 1-2 characters only');
                        return;
                    }
                    const color = document.getElementById('newTypeColor').value;
                    
                    if (!name) {
                        alert('Category name is required');
                        return;
                    }
                    
                    const taskCategories = getCurrentTaskCategories();
                    const oldCategory = taskCategories[index];
                    const oldName = typeof oldCategory === 'string' ? oldCategory : oldCategory.name;
                    
                    // Check if new name conflicts with existing categories (excluding current one)
                    const nameExists = taskCategories.some((cat, i) => {
                        if (i === index) return false; // Skip current category
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        return catName === name;
                    });
                    
                    if (nameExists) {
                        alert('A category with this name already exists');
                        return;
                    }
                    
                    // Update the category
                    const updatedCategory = {
                        name: name,
                        emoji: emoji,
                        color: color
                    };
                    taskCategories[index] = updatedCategory;
                    
                    // If name changed, update all tasks that use this category
                    if (oldName !== name) {
                        const workspace = getCurrentWorkspace();
                        workspace.tasks = workspace.tasks.map(task =>
                            task.taskCategory === oldName ? {...task, taskCategory: name} : task
                        );
                        workspace.completedTasks = workspace.completedTasks.map(task =>
                            task.taskCategory === oldName ? {...task, taskCategory: name} : task
                        );
                    }
                    
                    saveWorkspaces();
                    renderTypeManager();
                    updateTaskCategorySelects();
                    renderTasks(); // Refresh task display to show updated categories
                    
                    // Reset the form and button
                    resetCategoryForm();
                }

                function resetCategoryForm() {
                    document.getElementById('newTypeName').value = '';
                    document.getElementById('newTypeEmoji').value = '';
                    document.getElementById('newTypeColor').value = 'blue';
                    
                    const addButton = document.querySelector('button[onclick^="updateCategory"], button[onclick="addtaskCategory()"]');
                    addButton.textContent = 'Add';
                    addButton.setAttribute('onclick', 'addtaskCategory()');
                    
                    editingCategoryIndex = null;
                }
        
        // Task Category Management
        function addtaskCategory() {
            const name = document.getElementById('newTypeName').value.trim();
            const emoji = document.getElementById('newTypeEmoji').value.trim() || '📁';
            if (emoji && emoji.length > 2) {
                alert('Emoji should be 1-2 characters only');
                return;
            }
            const color = document.getElementById('newTypeColor').value;
            
            if (!name) {
                alert('Category name is required');
                return;
            }
            
            const taskCategories = getCurrentTaskCategories();
            
            // Check for duplicate names
            const nameExists = taskCategories.some(cat => {
                const catName = typeof cat === 'string' ? cat : cat.name;
                return catName === name;
            });
            
            if (nameExists) {
                alert('A category with this name already exists');
                return;
            }
            
            const newCategory = {
                name: name,
                emoji: emoji,
                color: color
            };
            
            taskCategories.push(newCategory);
            saveWorkspaces();
            renderTypeManager();
            updateTaskCategorySelects();
            
            // Clear inputs
            resetCategoryForm();
        }

        function removeTaskCategory(categoryName) {
            const workspace = getCurrentWorkspace();
            const taskCategories = workspace.taskCategories;
            
            // Count tasks using this category
            const tasksUsingCategory = workspace.tasks.filter(task => task.taskCategory === categoryName).length;
            const completedTasksUsingCategory = workspace.completedTasks.filter(task => task.taskCategory === categoryName).length;
            const totalTasks = tasksUsingCategory + completedTasksUsingCategory;
            
            let confirmMessage = `Delete the "${categoryName}" category?`;
            if (totalTasks > 0) {
                confirmMessage += `\n\nThis will affect ${totalTasks} task(s). They will be changed to "General" category.`;
            }
            
            if (confirm(confirmMessage)) {
                // Remove the category
                workspace.taskCategories = taskCategories.filter(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.name;
                    return catName !== categoryName;
                });
                
                // Update existing tasks to use 'General' if their category was removed
                workspace.tasks = workspace.tasks.map(task =>
                    task.taskCategory === categoryName ? {...task, taskCategory: 'General'} : task
                );
                workspace.completedTasks = workspace.completedTasks.map(task =>
                    task.taskCategory === categoryName ? {...task, taskCategory: 'General'} : task
                );
                
                saveWorkspaces();
                renderTypeManager();
                updateTaskCategorySelects();
                renderTasks(); // Refresh to show updated task categories
            }
        }

        function renderTypeManager() {
            const container = document.getElementById('typeList');
            const taskCategories = getCurrentTaskCategories();
            
            if (taskCategories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No categories yet. Add some below!</p>';
                return;
            }
            
            const html = taskCategories.map((category, index) => {
                // Handle both old string format and new object format
                const categoryName = typeof category === 'string' ? category : category.name;
                const categoryEmoji = typeof category === 'string' ? '📁' : (category.emoji || '📁');
                const categoryColor = typeof category === 'string' ? 'blue' : (category.color || 'blue');
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <span class="meta-item category-${categoryColor}">${categoryEmoji} ${categoryName}</span>
                        <div style="display: flex; gap: 4px;">
                            <button class="action-btn edit-btn" onclick="editCategory(${index})" title="Edit" style="width: 28px; height: 28px; font-size: 14px;">
                                ✏️
                            </button>
                            <button class="action-btn delete-btn" onclick="removeTaskCategory('${categoryName}')" title="Remove" style="width: 28px; height: 28px; font-size: 14px;">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        function updateTaskCategorySelects() {
            const select = document.getElementById('taskCategory');
            const currentValue = select.value;
            const taskCategories = getCurrentTaskCategories();
            
            let options = '<option value="General">General</option>';
            taskCategories.forEach(category => {
                // Handle both old string format and new object format
                const categoryName = typeof category === 'string' ? category : category.name;
                const categoryEmoji = typeof category === 'string' ? '' : (category.emoji || '');
                const categoryColor = typeof category === 'string' ? 'blue' : (category.color || 'blue');
                
                const displayText = categoryEmoji ? `${categoryEmoji} ${categoryName}` : categoryName;
                options += `<option value="${categoryName}" ${categoryName === currentValue ? 'selected' : ''}>${displayText}</option>`;
            });
            
            select.innerHTML = options;
        }

        function updatePrioritySelects() {
            const enabledFields = getCurrentEnabledFields();
            const select = document.getElementById('taskPriority');
            
            let options = '';
            let defaultValue = '';
            
            if (enabledFields.priorityLowHigh && enabledFields.priorityP0P3) {
                // Both enabled - show both systems
                options = `
                    <optgroup label="Low-High Priority">
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </optgroup>
                    <optgroup label="P0-P3 Priority">
                        <option value="P0">P0 - Critical</option>
                        <option value="P1">P1 - High</option>
                        <option value="P2">P2 - Medium</option>
                        <option value="P3">P3 - Low</option>
                    </optgroup>
                `;
                defaultValue = 'Medium';
            } else if (enabledFields.priorityLowHigh) {
                // Only Low-High
                options = `
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Low">Low</option>
                `;
                defaultValue = 'Medium';
            } else if (enabledFields.priorityP0P3) {
                // Only P0-P3
                options = `
                    <option value="P0">P0 - Critical</option>
                    <option value="P1">P1 - High</option>
                    <option value="P2" selected>P2 - Medium</option>
                    <option value="P3">P3 - Low</option>
                `;
                defaultValue = 'P2';
            }
            
            select.innerHTML = options;
            if (defaultValue) {
                select.value = defaultValue;
            }
        }
        
        function updateModalFieldVisibility() {
            const enabledFields = getCurrentEnabledFields();
            
            // Show/hide fields based on workspace settings
            document.getElementById('dueDateGroup').style.display = enabledFields.dueDate ? 'block' : 'none';
            document.getElementById('timeEstimateGroup').style.display = enabledFields.timeEstimate ? 'block' : 'none';
            document.getElementById('taskCategoryGroup').style.display = enabledFields.categories ? 'block' : 'none';
            
            // Hide priority section if neither priority system is enabled
            const priorityGroup = document.getElementById('priorityGroup');
            if (!enabledFields.priorityLowHigh && !enabledFields.priorityP0P3) {
                priorityGroup.style.display = 'none';
            } else {
                priorityGroup.style.display = 'block';
            }
        }
        
        // Archive Management
        function deleteFromArchive(taskId) {
            getCurrentWorkspace().completedTasks = getCurrentWorkspace().completedTasks.filter(t => t.id !== taskId);
            saveWorkspaces();
            updateArchiveCount();
            renderTasks();
        }

        function updateArchiveCount() {
            document.getElementById('archive-count').textContent = getCurrentCompletedTasks().length;
        }

        // Modal Management
        function showAddModal() {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('taskForm').reset();
            updatePrioritySelects();
            updateTaskCategorySelects();
            updateModalFieldVisibility();
            applyFieldDefaults();
            setupFieldValidationListeners();
            showModal('taskModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal() {
            const openModal = document.querySelector('.modal.show');
            if (openModal) {
                openModal.classList.remove('show');
            }
        }

        function toggleCategoryManager() {
            renderTypeManager();
            updateTaskCategorySelects();
            showModal('typeModal');
        }

        function closeCategoryManager() {
            resetCategoryForm();
            closeModal();
        }

        function toggleArchive() {
            showingArchive = !showingArchive;
            renderTasks();
            
            const btn = document.querySelector('[onclick="toggleArchive()"]');
            btn.innerHTML = showingArchive ?
                '📋 Active Tasks' :
                '🗄️ Archive (<span id="archive-count">' + getCurrentCompletedTasks().length + '</span>)';
        }

        // App Settings
        function showSettingsModal() {
            document.getElementById('appNameInput').value = appName.replace('🤖 ', '');
            showModal('settingsModal');
        }

        function saveAppSettings() {
            const newName = document.getElementById('appNameInput').value.trim();
            if (newName) {
                appName = newName.includes('🤖') ? newName : `🤖 ${newName}`;
                localStorage.setItem('aiTaskTracker_appName', appName);
                updateAppName();
                closeModal();
            }
        }

        function updateAppName() {
            document.getElementById('app-name').textContent = appName;
            document.getElementById('app-title').textContent = appName.replace('🤖 ', '');
            
            // Update PWA manifest
            if ('serviceWorker' in navigator) {
                const manifest = {
                    "name": appName.replace('🤖 ', ''),
                    "short_name": appName.replace('🤖 ', '').substring(0, 12),
                    "description": "Smart task tracker with AI input parsing",
                    "start_url": "./",
                    "display": "standalone",
                    "background_color": "#ffffff",
                    "theme_color": "#3b82f6",
                    "icons": [
                        {
                            "src": "icon-192.png",
                            "sizes": "192x192",
                            "type": "image/png"
                        },
                        {
                            "src": "icon-512.png",
                            "sizes": "512x512",
                            "type": "image/png"
                        }
                    ]
                };
                
                const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(manifestBlob);
                const manifestLink = document.getElementById('pwa-manifest');
                if (manifestLink) {
                    manifestLink.href = manifestURL;
                }
            }
        }

        // Voice Input
        function startVoiceInput() {
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input not supported in this browser. Try Chrome or Safari.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            voiceBtn.textContent = '🛑 Stop';
            voiceBtn.onclick = function() { stopVoiceInput(recognition); };
            voiceBtn.disabled = false;

            // Show live transcript
            let finalTranscript = '';

            recognition.onresult = function(event) {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show live transcript in text box
                document.getElementById('quickInput').value = finalTranscript + interimTranscript;
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                alert('Voice input failed. Please try again.');
                resetVoiceButton();
            };

            recognition.onend = function() {
                resetVoiceButton();
            };

            try {
                recognition.start();
            } catch (error) {
                console.error('Failed to start speech recognition:', error);
                alert('Could not start voice input. Please try again.');
                resetVoiceButton();
            }
        }

        function showVoicePreview(voiceText) {
            const status = document.getElementById('parseStatus');
            status.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 6px; padding: 10px; margin-top: 8px;">
                    <div style="color: #16a34a; font-weight: 600; margin-bottom: 8px;">Voice captured:</div>
                    <div style="color: #374151; margin-bottom: 10px;">"${voiceText}"</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="confirmVoiceInput()" style="background: #22c55e; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">✓ Add Task</button>
                        <button onclick="editVoiceInput()" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">✏️ Edit</button>
                        <button onclick="cancelVoiceInput()" style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">✕ Cancel</button>
                    </div>
                </div>
            `;
            status.style.display = 'block';
        }

        function confirmVoiceInput() {
            parseQuickInput();
            document.getElementById('parseStatus').style.display = 'none';
        }

        function editVoiceInput() {
            document.getElementById('quickInput').focus();
            document.getElementById('parseStatus').style.display = 'none';
        }

        function cancelVoiceInput() {
            document.getElementById('quickInput').value = '';
            document.getElementById('parseStatus').style.display = 'none';
        }
        
        function resetVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                voiceBtn.textContent = '🎤 Voice';
                voiceBtn.onclick = function() { startVoiceInput(); };
                voiceBtn.disabled = false;
            }
        }

        function toggleNotes(taskId) {
            const notesDiv = document.getElementById(`notes-${taskId}`);
            const toggleIcon = document.querySelector(`button[onclick="toggleNotes(${taskId})"] .toggle-icon`);
            
            if (notesDiv.style.display === 'none') {
                notesDiv.style.display = 'block';
                toggleIcon.classList.add('expanded');
            } else {
                notesDiv.style.display = 'none';
                toggleIcon.classList.remove('expanded');
            }
        }
        
        function stopVoiceInput(recognition) {
            recognition.stop();
            const finalText = document.getElementById('quickInput').value.trim();
            if (finalText) {
                showVoicePreview(finalText);
            }
            resetVoiceButton();
        }
        
        function getTodayDateString() {
            const today = new Date();
            return formatDate(today);
        }

        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        }

        function getNextWeekday(targetDay) {
            const today = new Date();
            const currentDay = today.getDay();
            let daysUntilTarget = targetDay - currentDay;
            if (daysUntilTarget <= 0) daysUntilTarget += 7;
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysUntilTarget);
            return formatDate(targetDate);
        }
        
        function disconnectRealtimeListener() {
                    if (userDataRef) {
                        userDataRef.off();
                    }
                }
        
        // Data Persistence
        function saveWorkspaces() {
            
            // Save to localStorage as backup
            localStorage.setItem('aiTaskTracker_workspaces', JSON.stringify(workspaces));
            localStorage.setItem('aiTaskTracker_workspaceOrder', JSON.stringify(workspaceOrder));
            
            // Save to Firebase if user is authenticated
            if (userDataRef && currentUser) {
                const data = {
                    workspaces,
                    currentWorkspace,
                    workspaceOrder,
                    appName,
                    lastUpdated: Date.now()
                };
                userDataRef.set(data).catch(error => {
                    console.error('Firebase save error:', error);
                });
            }
        }

            function refreshFromFirebase() {
                const refreshBtn = document.querySelector('button[onclick="refreshFromFirebase()"]');
                const originalText = refreshBtn.textContent;
                
                if (!currentUser || !userDataRef) {
                    alert('Please log in to refresh data from server.');
                    return;
                }
                
                refreshBtn.textContent = '⏳ Refreshing...';
                refreshBtn.disabled = true;
                
                userDataRef.once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data && data.workspaces) {
                        workspaces = data.workspaces;
                        currentWorkspace = data.currentWorkspace || currentWorkspace;
                        workspaceOrder = data.workspaceOrder || Object.keys(workspaces);
                        
                        renderWorkspaceTabs();
                        switchToWorkspace(currentWorkspace);
                        updateArchiveCount();
                        
                        refreshBtn.textContent = '✅ Refreshed!';
                    } else {
                        refreshBtn.textContent = '⚠️ No Data';
                        alert('No data found on server.');
                    }
                    
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                        refreshBtn.disabled = false;
                    }, 2000);
                    
                }).catch(error => {
                    console.error('Refresh failed:', error);
                    refreshBtn.textContent = '❌ Failed';
                    alert('Failed to refresh data from server. Please check your connection.');
                    
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                        refreshBtn.disabled = false;
                    }, 2000);
                });
            }
        
        function loadDataFromFirebase() {
            if (!userDataRef) return;
            
            userDataRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && data.workspaces) {
                    // Load data from Firebase
                    workspaces = data.workspaces;
                    currentWorkspace = data.currentWorkspace || 'Work';
                    appName = data.appName || 'AI Task Tracker';
                    workspaceOrder = data.workspaceOrder || Object.keys(workspaces);
                    
                    // Update UI
                    renderWorkspaceTabs();
                    switchToWorkspace(currentWorkspace);
                    updateAppName();
                    
                    // Set up real-time listener
                    setupRealtimeListener();
                } else {
                    // No data in Firebase, use localStorage or defaults
                    const localData = localStorage.getItem('aiTaskTracker_workspaces');
                    if (localData) {
                        workspaces = JSON.parse(localData);
                    }
                    const localOrder = localStorage.getItem('aiTaskTracker_workspaceOrder');
                    if (localOrder) {
                        workspaceOrder = JSON.parse(localOrder);
                    }
                    // Save current data to Firebase
                    saveWorkspaces();
                }
            }).catch(error => {
                console.error('Firebase load error:', error);
                // Fall back to localStorage
                const localData = localStorage.getItem('aiTaskTracker_workspaces');
                if (localData) {
                    workspaces = JSON.parse(localData);
                }
            });
        }

        function setupRealtimeListener() {
            if (!userDataRef) return;
            
            userDataRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data && data.workspaces && data.lastUpdated) {
                    const localLastUpdate = parseInt(localStorage.getItem('aiTaskTracker_lastUpdate') || '0');
                    
                    // Only update if the remote data is newer
                    if (data.lastUpdated > localLastUpdate) {
                        workspaces = data.workspaces;
                        currentWorkspace = data.currentWorkspace || currentWorkspace;
                        
                        renderWorkspaceTabs();
                        renderTasks();
                        updateArchiveCount();
                        
                        localStorage.setItem('aiTaskTracker_lastUpdate', data.lastUpdated.toString());
                    }
                }
            });
        }
        
        // Export/Import Functions
        function exportData() {
            const exportData = {
                version: "2.0",
                exportDate: new Date().toISOString(),
                username: currentUser,
                workspaces: workspaces,
                currentWorkspace: currentWorkspace,
                appName: appName
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `task-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.version || !importedData.workspaces) {
                            alert('Invalid backup file format');
                            return;
                        }
                        
                        if (confirm('This will replace all your current data. Are you sure?')) {
                            workspaces = importedData.workspaces;
                            currentWorkspace = importedData.currentWorkspace || 'Work';
                            appName = importedData.appName || 'AI Task Tracker';
                            
                            saveWorkspaces();
                            renderWorkspaceTabs();
                            switchToWorkspace(currentWorkspace);
                            updateAppName();
                            
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Error reading backup file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Click outside modal to close
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) {
                    closeModal();
                }
            }
        });
    </script>
</body>
</html>
